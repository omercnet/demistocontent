category: Endpoint
commonfields:
  id: Microsoft Defender Advanced Threat Protection
  version: -1
configuration:
- defaultvalue: https://api.securitycenter.windows.com
  display: Host URL (e.g. https://api.securitycenter.windows.com)
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: ID (received from the admin consent - see Detailed Instructions (?) section)
  name: auth_id
  required: true
  type: 4
- defaultvalue: ""
  display: Token (received from the admin consent - see Detailed Instructions (?)
    section)
  name: tenant_id
  required: true
  type: 4
- defaultvalue: ""
  display: Key (received from the admin consent - see Detailed Instructions (?) section)
  name: enc_key
  required: true
  type: 4
- defaultvalue: ""
  display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- defaultvalue: ""
  display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: New
  display: 'Status to filter out alerts for fetching as incidents. The property values
    are: New,InProgress,Resolved (Comma separated values supported, e.g. New,Resolved)'
  name: fetch_status
  options:
  - New
  - InProgress
  - Resolved
  required: false
  type: 16
- defaultvalue: Informational,Low,Medium,High
  display: 'Severity to filter out alerts for fetching as incidents. The property
    values are: Informational,Low,Medium,High (Comma separated values supported, e.g.
    Medium,High)'
  name: fetch_severity
  options:
  - Informational
  - Low
  - Medium
  - High
  required: false
  type: 16
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: 3 days
  display: First fetch timestamp (<number> <time unit>, e.g., 12 hours, 7 days)
  name: first_fetch_timestamp
  required: false
  type: 0
contentitemexportablefields:
  contentitemfields:
    propagationLabels:
    - all
description: Microsoft Defender Advanced Threat Protection (ATP) is a unified platform
  for preventative protection, post-breach detection, automated investigation, and
  response.
detaileddescription: |
  To allow us access to Microsoft Defender Advanced Threat Protection, an admin has to approve our app using an admin consent flow, by clicking on the following [link](https://oproxy.demisto.ninja/ms-defender-atp).
  After authorizing the Demisto app, you will get an ID, Token, and Key, which should be inserted in the integration instance configuration's corresponding fields.
display: Microsoft Defender Advanced Threat Protection
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAAAXNSR0IArs4c6QAAC+9JREFUeAHtWXtwVNUZP+c+du9udiGB8DBjImkFWrRTpB1ardToQAVEyggZx9ZSBOQ5FAgJFGw1UssrD94BeQz4oB3hj7ZDBdERqUPRGW1x6kyAgI0ELIRHXvu+ex/9fQub7i7ZZBXoxJlzmMve+53vO4/f9zwnjIkmEBAICAQEAgIBgYBAQCAgEBAICAQEAgIBgYBAQCAgEBAICAQEAgIBgYBA4CYQ4JnInnrcm+tUXOWyxBxWJwJOzrnpZ4e3L22MuCw2Ro8wOx07p5k5M7nGlj/3Y3YhHZ+g3xwCSibi3JJ6MJvPcckSt+z0NuGSOQvIhmXbzO90s+lSelZGCo5GGYuE2GasQSg4E0V8BZ6MFGy54YlRFgyZdhZpL32TmG1Zum1Cd2HG4MFpGynYspjOLPwT7bYhkJGCb9vsYuAOEVi6dGlvy7LyWluVpq1bf/9Fh0wZEruNgouLix35+YU/kmVb1XU9vH79+qPYQ4fevXjx4sG2bd9Fe7xy5crxXbt2XYa8q6CgAOFevlNR+PTVq1c3ZIhBd2KTysrKSg3DXKiqan+PJ/IBFvfAzSxQuhnhWyk7cODAHEmy/yTLyiGnU3uvpKRkeEfjz5gxQ4V1v64o6iF6cnJyfkB8hYWFOZzLT7nd2qhw2BjckWx3p8Fwx2FPq2G8qmkay7HPXVgz6Yhj33csWLBgGL1/mX10Gw+mRWNDZjQatR0Oh4QN/hKkD1M3k52d/SDKgO/Dy01FUWTIxIqCNWvW/GfhwoWj/f5or1AocCRV7uvwjZrkYU1TWSQS3lhZWfFifM3Y13AY/V8NI1oH2oNxeia/3UrBOGWRtV6MRKIK3ieVlpa+UFlZeSlxIwhfz0qShPLNPovfQYl9a9eu/Vvid8q7NG3atOzc3FwT4bs1pa/9E57i3rZtW7CdgBeieb1et8/nC6b2JfJNmTIlu3///nzVqlU0/g3pZcyYMc6hQ4d6WltbIzU1Nf5EWXq3LCOmD1mWk/aMcO0FrU80qp9IlenqOyN3P1ncs1CLap/KMkcVnX5IHKOY6Y9u2lJ6OeBV2BIdlXS6Fq+iDYvdVz6W1S5btqyfrkdPwYobZJl9oGmuGYGAf1Z1dfXL8THmzp17V1aWp9YwrMOcWyqs+tFgMDBu3bp1bwJcrXfv3Fdsm/dDCf/0xo0bz5Mc5eb8/Py5AOgpOPs3YDg4CPCPkKefRCi0TJP9kaCVZQkh0V6JiHB3OBwaBQWcgYHdi5xexpj5MKIGUgC/inW/i2FXVFRUfBZfF0LnJEVxzuPc/g5oEoY9iwgzacOGDaeJZ968eXe6XK4yy+JjMVc/zOtH8DkWDodXo9b4aM6cOfkul+cPkB8Eo+2L/TVAqZewj/VY6z1Op/qEaVqDIOfDGk6Zpl3v97f+HMaGg2bnLaMcLAUZtzlXVXCrONymexT028yW4YdIpYCmiwfZRJW05JyCTcoI07sjcGM49DN79+6V41sASD9D+HbbtrEDG00yNQrraA/ACB+CktwkU1RUrqHwet3t9lSQckF6C4o6CKAKgsGgF0rA2NYI0B8xDPtVjHkvHr/T6WSU72AUhx0OZTL46wH0XiiuBUY1Fd9vLVmypIDmQN6cANpejDME/a8Agc22LbVhPb2on/jQ/47D4fwV5HxQMsbhZwDQRE3TDi1a9OvvZWVlQVEmKeu614OLW9g/RxqSDKzdpLEgDzUwA2x4MmuxkNAVq8vdGlHCkX9y03LhwiMtu6TITDODDVhpKBRh/8KSk5SQKohoEMWWQsl02wHwP5Yk+QiseOTRo/+gIuoYeSL2NzUUCtWfP3/+7fz8gvnJcti2ZesEABQTm3fYsLZfuFxZT8AjTyK8jY97FIXSxsbGEIVLRI0wlNFX141/NzVdnQxZX3NzM4dhHFJVR59wOPK7qqqq52kuihJ9+khvuN1Z40Oh4AKQSgyDjfN6Ne7zta1GtKmMr6m4uNxB76Zp/gb830I02tPQ0DB13759OtFRLa9DlJofjYaWIxo8BtIjKCw3uN3ueT5foAphfhPxUYMRHUa9cRg5+DhqjaIYMcP/MlLwhJH7m/PYHS9ItqFw6Rp4HY0vWwoPMsfnb7TdY4a97LRppVcwuaUBd29uYpfKkwbjjEIPwuMOADzKNINT0H0sL69wlMvlvBshuRwghUpKytJGn7iC4QHFNDTC26q4cul79+7dLfQ7ZMgQL7yNQwmWYURe3LlzZxPRMXchPP1+hNCr8MoNRKMGufCiRYtqEGHGQ6SIaOj/BBEDN3PyXCjC39bWtn/r1q1f7NtXrmOcLBjlKBiliWhRFVcuycGIa1AQz0YgGk7n3pUrV14FOeY9shyrnIkt3mJ7xTzpvSvOmfKbkYJ7SwP7RRyOP0uSAi+6oXZoH1J2uFgooG6G6UadMltgtQfXdpb2F8rBMACjt4N9F8Ta9g680JkYABwAyGfBNxGgLkPImgqQIuGwvSeRt6N3hPcYGVEgD8qg4iVp/EQZAMwNw/DDi8/F6ZDJRVh1QvGfobBKKsigsIvgZ5LEe1DR1Nx8ZYck9RmAHD4ToX2L18tfgiduHDx48Ira2loPjDQHMkGs6WJ8fPpFeG6CwtrwmoWI4cUvKfiWt7RecMNMNtRhmYx38lC/hRoGYTd2AQkJUmLaB7ZixeJVymTISRJVmQDxNQDdC7l1GYx7JIA9WFOz9kwKe9pPeFkI3gzv4n3TMqED/UlWi28/lGvCuHoFAnmuRFnLknIQLmE0vNXj8Rjk1VVVFaUw/KGBQKjMtk0dIbn85MnTM+vq6hApbEpBGkJvduI4mMOLGsMDWgBneV9iX7p34NBpyutILnMFdyR9m2nBoPIaLD8AFcyDorIA1vZMpoQCYqFMktj7pGBZdsxHVCAwY23GjHI3jj4qvLZDwFpaWupRztSiMOrft69/clyOfqHbZ1AbwCisdxFyTVTIPYhOVXV1dUUlvPV5KAIebo84ePBgBN8fojiEiDqT+OIN3vu0y6VpMKK/IzzHUkO8L/UXESW2H8jEisfU/s6+MwrRnQ1wK/tQJKmw7PY1bd68sq6kZNE78OgJCNm1TU1Nh+PzAUDlGpD/+5sVPF4BoAo5H/EFg9Y61Hs/BZCjCgoKj6KweRP9DpxSHpLl7Al4J++i+VTijzfySlwu/NYwpH2qKm9ELr0f4NZhvh8iooxGTj0Bw8HYjMFIVqJSzoYS3sfaNRjjdPDCw633qB+KXY5CbQRC9XzUDd9EPPsY54tvozp/EinnMmTKwRY3NJn2BPEkx8NcF8GLCloahj28jLHPIvxXkQHRHJ21pIE6Y7zdffBUOgogV/LTqHDjG4b3SVsQmgEuryHgE9ZRD1BPY7OxCwMAgPOtVYeH8m1s4zU11eeQtscA4L04PhVgbAr1c+GdjX6/vw0KRmiWTiLXn8A4SUcPXJr8BVXrBHjYUchMxLGmHL/DcXp71efTx9LNGa0FCjkLJT0K8Lfgqca3ExVz6fHjx3dQP6rh47haH4Mq/gD2UETjIO8/hqn348ZqNDz/E+K73i5gr9iTlJSPcdlTi7Ffwjyg82ex3sdxtsfau24xS++K7SfbTxYyVf4UDpKFvwemZZdQZPnDjk1v5+TqPJuV0J8M0zUAR0Ppts7u806IFVkcRYsDec1OrDZJvqioSDty5EjSaFSIUa6G0imNxxZFNCiOw7KJ1m4kNAZCaR9N69lDVS3/ihUrGomGFpuTXjqSIToanzXruTyvV9cQQZrjlfa1rmv/z549O6dnz545Pl/UDASuNqYYYjsrXea0tIS8brfclnpDR0zYpzJgwAAlEAhEKfy3C15/oT1gHk99ff3VPXv2UIHWZetOCu5ysYLhyyPQbUL0l1+6kMgEAaHgTFD6GvO0V6yd7cGSdZSnboXjjNBpDsblM47BdA+D22iUp3jSNcrBURsVbMpddDp+Qf9qCGSk4IAn54K3NUB/CelEZTgAYA26qZ7Tcd/h0NmBcMotc+ISFRwo0KwAZ5/H3sR/AgGBgEBAICAQEAgIBAQCAgGBgEBAICAQEAgIBAQCAgGBgEBAICAQEAgIBAQCAgGBwP8Zgf8CqLeLzH1CkPwAAAAASUVORK5CYII=
name: Microsoft Defender Advanced Threat Protection
script:
  commands:
  - arguments:
    - default: true
      description: Machine ID to be used for isolation. e.g. 0a3250e0693a109f1affc9217be9459028aa8426
      name: machine_id
      required: true
    - description: A comment to associate with the action.
      name: comment
      required: true
    - auto: PREDEFINED
      description: Full isolation or Selective isolation (Restrict only limited set
        of applications from accessing the network)
      name: isolation_type
      predefined:
      - Full
      - Selective
      required: true
    description: Isolates a machine from accessing external networks.
    execution: true
    name: microsoft-atp-isolate-machine
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: Type of the machine action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: Scope of the action
      type: Unknown
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: Comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created.
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated.
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5".'
      type: String
  - arguments:
    - description: Machine ID to be used to stop the isolation. e.g. 0a3250e0693a109f1affc9217be9459028aa8426
      name: machine_id
      required: true
    - description: Comment to associate with the action.
      name: comment
      required: true
    description: Undo an isolation of a machine.
    name: microsoft-atp-unisolate-machine
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: Type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: Scope of the action
      type: Unknown
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The fileIdentifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - description: The computer DNS name.
      name: hostname
    - description: The last machine IP to access the internet.
      name: ip
    - auto: PREDEFINED
      description: The machine risk score.
      name: risk_score
      predefined:
      - Low
      - Medium
      - High
    - auto: PREDEFINED
      description: The machine health status.
      name: health_status
      predefined:
      - Active
      - Inactive
    - description: The machine's OS platform. Only a single platform can be added.
      name: os_platform
    description: Retrieves a collection of machines that have communicated with WDATP
      cloud on the last 30 days.
    name: microsoft-atp-get-machines
    outputs:
    - contextPath: MicrosoftATP.Machine.ID
      description: The machine ID
      type: String
    - contextPath: MicrosoftATP.Machine.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.Machine.FirstSeen
      description: The first date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.Machine.LastSeen
      description: The last date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.Machine.OSPlatform
      description: The operating system platform
      type: String
    - contextPath: MicrosoftATP.Machine.OSVersion
      description: The operating system Version
      type: String
    - contextPath: MicrosoftATP.Machine.OSProcessor
      description: The operating system processor
      type: String
    - contextPath: MicrosoftATP.Machine.LastIPAddress
      description: The last IP on the machine
      type: String
    - contextPath: MicrosoftATP.Machine.LastExternalIPAddress
      description: The last machine IP to access the internet
      type: String
    - contextPath: MicrosoftATP.Machine.OSBuild
      description: The operating system build number
      type: Number
    - contextPath: MicrosoftATP.Machine.HealthStatus
      description: The machine health status
      type: String
    - contextPath: MicrosoftATP.Machine.RBACGroupID
      description: The machine RBAC group ID
      type: Number
    - contextPath: MicrosoftATP.Machine.RBACGroupName
      description: The machine RBAC group Name
      type: String
    - contextPath: MicrosoftATP.Machine.RiskScore
      description: The machine risk score
      type: String
    - contextPath: MicrosoftATP.Machine.ExposureLevel
      description: The machine exposure score
      type: String
    - contextPath: MicrosoftATP.Machine.IsAADJoined
      description: True if machine is AAD joined, False otherwise
      type: Boolean
    - contextPath: MicrosoftATP.Machine.AADDeviceID
      description: The AAD Device ID
      type: String
    - contextPath: MicrosoftATP.Machine.MachineTags
      description: Set of machine tags
      type: String
  - arguments:
    - description: File SHA1 hash to get the related machines
      name: file_hash
      required: true
    description: Get a collection of machines related to a given file SHA1 hash.
    name: microsoft-atp-get-file-related-machines
    outputs:
    - contextPath: MicrosoftATP.FileMachine.Machines.ID
      description: The machine ID
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.FirstSeen
      description: The first date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.FileMachine.Machines.LastSeen
      description: The last date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.FileMachine.Machines.OSPlatform
      description: The operating system platform
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.OSVersion
      description: The operating system Version
      type: String
    - contextPath: MicrosoftATP.Machine.OSProcessor
      description: The operating system processor
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.OSBuild
      description: Operating system build number
      type: Number
    - contextPath: MicrosoftATP.FileMachine.Machines.LastIPAddress
      description: The last IP on the machine
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.LastExternalIPAddress
      description: The last machine IP to access the internet
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.HelathStatus
      description: The machine health status
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.RBACGroupID
      description: The machine RBAC group ID
      type: Number
    - contextPath: MicrosoftATP.FileMachine.Machines.RBACGroupName
      description: The machine RBAC group Name
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.RiskScore
      description: The machine risk score
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.ExposureLevel
      description: The machine exposure score
      type: String
    - contextPath: MicrosoftATP.FileMachine.Machines.IsAADJoined
      description: True if machine is AAD joined, False otherwise
      type: Boolean
    - contextPath: MicrosoftATP.FileMachine.Machines.AADDeviceID
      description: The AAD Device ID
      type: string
    - contextPath: MicrosoftATP.FileMachine.Machines.MachineTags
      description: Set of machine tags
      type: String
    - contextPath: MicrosoftATP.FileMachine.File
      description: The machine related file hash
      type: String
  - arguments:
    - default: true
      description: Machine id to be used for getting the machine details, e.g. 0a3250e0693a109f1affc9217be9459028aa8426
      name: machine_id
      required: true
    description: Get a machine details by its identity.
    name: microsoft-atp-get-machine-details
    outputs:
    - contextPath: MicrosoftATP.Machine.ID
      description: The machine ID
      type: String
    - contextPath: MicrosoftATP.Machine.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.Machine.FirstSeen
      description: The first date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.Machine.LastSeen
      description: The last date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.Machine.OSPlatform
      description: The operating system platform
      type: String
    - contextPath: MicrosoftATP.Machine.OSVersion
      description: The operating system Version
      type: String
    - contextPath: MicrosoftATP.Machine.OSProcessor
      description: The operating system processor
      type: String
    - contextPath: MicrosoftATP.Machine.LastIPAddress
      description: The last IP on the machine
      type: String
    - contextPath: MicrosoftATP.Machine.LastExternalIPAddress
      description: The last machine IP to access the internet
      type: String
    - contextPath: MicrosoftATP.Machine.OSBuild
      description: The operating system build number
      type: Number
    - contextPath: MicrosoftATP.Machine.HealthStatus
      description: The machine health status
      type: String
    - contextPath: MicrosoftATP.Machine.RBACGroupID
      description: The machine RBAC group ID
      type: Number
    - contextPath: MicrosoftATP.Machine.RBACGroupName
      description: The machine RBAC group Name
      type: String
    - contextPath: MicrosoftATP.Machine.RiskScore
      description: The machine risk score
      type: String
    - contextPath: MicrosoftATP.Machine.ExposureLevel
      description: The machine exposure level
      type: String
    - contextPath: MicrosoftATP.Machine.IsAADJoined
      description: True if machine is AAD joined, False otherwise
      type: Boolean
    - contextPath: MicrosoftATP.Machine.AADDeviceID
      description: The AAD Device ID
      type: String
    - contextPath: MicrosoftATP.Machine.MachineTags
      description: Set of machine tags
      type: String
  - arguments:
    - description: The machine ID to run the scan on.
      name: machine_id
      required: true
    - description: A comment to associate with the action.
      name: comment
      required: true
    - auto: PREDEFINED
      description: Defines the type of the scan.
      name: scan_type
      predefined:
      - Quick
      - Full
      required: true
    description: Initiate a Microsoft Defender Antivirus scan on a machine.
    name: microsoft-atp-run-antivirus-scan
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: The type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: The scope of the action
      type: Unknown
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - auto: PREDEFINED
      description: Alert severity.
      name: severity
      predefined:
      - High
      - Medium
      - Low
      - Informational
    - auto: PREDEFINED
      description: Alert status.
      name: status
      predefined:
      - New
      - InProgress
      - Resolved
    - description: Alert category, only one can be added.
      name: category
    description: Get a list of alerts present on the system. Filtering can be done
      only on a single argument.
    name: microsoft-atp-list-alerts
    outputs:
    - contextPath: MicrosoftATP.Alert.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.Alert.IncidentID
      description: The Incident ID of the Alert
      type: Number
    - contextPath: MicrosoftATP.Alert.InvestigationID
      description: The Investigation ID related to the Alert
      type: Number
    - contextPath: MicrosoftATP.Alert.InvestigationState
      description: The current state of the Investigation
      type: String
    - contextPath: MicrosoftATP.Alert.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Classification
      description: The alert Classification
      type: String
    - contextPath: MicrosoftATP.Alert.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.Alert.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.ThreatFamilyName
      description: The threat family
      type: String
    - contextPath: MicrosoftATP.Alert.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.Alert.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.Alert.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.Alert.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.Alert.MachineID
      description: The machine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.Alert.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.Alert.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.Comment
      description: The alert comment string
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - description: Alert ID to update.
      name: alert_id
      required: true
    - auto: PREDEFINED
      description: Alert status to update.
      name: status
      predefined:
      - New
      - InProgress
      - Resolved
    - description: Owner of the alert.
      name: assigned_to
    - auto: PREDEFINED
      description: Specifies the specification of the alert.
      name: classification
      predefined:
      - Unknown
      - FalsePositive
      - TruePositive
    - auto: PREDEFINED
      description: Specifies the determination of the alert.
      name: determination
      predefined:
      - NotAvailable
      - Apt
      - Malware
      - SecurityPersonnel
      - SecurityTesting
      - UnwantedSoftware
      - Other
    - description: Comment to be added to the alert.
      name: comment
    description: Update the properties of an alert entity.
    name: microsoft-atp-update-alert
    outputs:
    - contextPath: MicrosoftATP.Alert.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.Alert.IncidentID
      description: The Incident ID of the alert
      type: Number
    - contextPath: MicrosoftATP.Alert.InvestigationID
      description: The Investigation ID related to the alert
      type: Number
    - contextPath: MicrosoftATP.Alert.InvestigationState
      description: The current state of the Investigation
      type: String
    - contextPath: MicrosoftATP.Alert.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Classification
      description: The alert classification
      type: String
    - contextPath: MicrosoftATP.Alert.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.Alert.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.ThreatFamilyName
      description: The threat family
      type: String
    - contextPath: MicrosoftATP.Alert.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.Alert.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.Alert.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.Alert.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.Alert.MachineID
      description: The mahine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.Alert.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.Alert.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.Comment
      description: The alert comment string
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - default: true
      description: The query to run.
      name: query
      required: true
    description: 'Allows you to run programmatic queries like in Microsoft Defender
      ATP Portal (https://securitycenter.windows.com/hunting). Limitations: You can
      only run a query on data from the last 30 days, The results will include a maximum
      of 10,000 rows, The number of executions is limited (up to 15 calls per minute,
      15 minutes of running time every hour and 4 hours of running time a day).'
    name: microsoft-atp-advanced-hunting
    outputs:
    - contextPath: MicrosoftATP.Hunt.Result
      description: The query results.
      type: String
  - arguments:
    - description: Id of the machine on which the event was identified.
      name: machine_id
      required: true
    - auto: PREDEFINED
      description: Severity of the alert.
      name: severity
      predefined:
      - Low
      - Medium
      - High
      required: true
    - description: Title for the alert.
      name: title
      required: true
    - description: Description of the alert.
      name: description
      required: true
    - description: Action that is recommended to be taken by security officer when
        analyzing the alert.
      name: recommended_action
      required: true
    - description: The time of the event, as obtained from the advanced query.
      name: event_time
      required: true
    - description: The reportId, as obtained from the advanced query.
      name: report_id
      required: true
    - auto: PREDEFINED
      defaultValue: None
      description: Category of the alert.
      name: category
      predefined:
      - None
      - SuspiciousActivity
      - Malware
      - CredentialTheft
      - Exploit
      - WebExploit
      - DocumentExploit
      - PrivilegeEscalation
      - Persistence
      - RemoteAccessTool
      - CommandAndControl
      - SuspiciousNetworkTraffic
      - Ransomware
      - MalwareDownload
      - Reconnaissance
      - WebFingerprinting
      - Weaponization
      - Delivery
      - SocialEngineering
      - CredentialStealing
      - Installation
      - Backdoor
      - Trojan
      - TrojanDownloader
      - LateralMovement
      - ExplorationEnumeration
      - NetworkPropagation
      - Exfiltration
      - NotApplicable
      - EnterprisePolicy
      - General
      required: true
    description: Create a new alert entity using event data, as obtained from the
      Advanced Hunting.
    name: microsoft-atp-create-alert
    outputs:
    - contextPath: MicrosoftATP.Alert.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.Alert.IncidentID
      description: The Incident ID of the alert
      type: Number
    - contextPath: MicrosoftATP.Alert.InvestigationID
      description: The Investigation ID related to the alert
      type: Number
    - contextPath: MicrosoftATP.Alert.InvestigationState
      description: The current state of the Investigation
      type: String
    - contextPath: MicrosoftATP.Alert.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.Classification
      description: The alert Classification
      type: String
    - contextPath: MicrosoftATP.Alert.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.Alert.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.Alert.ThreatFamilyName
      description: The threat family
      type: String
    - contextPath: MicrosoftATP.Alert.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.Alert.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.Alert.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.Alert.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.Alert.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.Alert.MachineID
      description: The mahine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.Alert.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.Alert.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.Comment
      description: The alert Comment string
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.Alert.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - description: ID of the alert.
      name: id
      required: true
    description: Retrieves the user associated to a specific alert.
    name: microsoft-atp-get-alert-related-user
    outputs:
    - contextPath: MicrosoftATP.AlertUser.User.ID
      description: The user ID
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.AccountName
      description: The account name
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.AccountDomain
      description: The account domain
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.AccountSID
      description: The account SID
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.FirstSeen
      description: The user first seen date time
      type: Date
    - contextPath: MicrosoftATP.AlertUser.User.LastSeen
      description: The user last seen date time
      type: Date
    - contextPath: MicrosoftATP.AlertUser.User.MostPrevalentMachineID
      description: The most prevelent machine ID
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.LeastPrevalentMachineID
      description: The least prevelent machine ID
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.LogonTypes
      description: The user logon types
      type: String
    - contextPath: MicrosoftATP.AlertUser.User.LogonCount
      description: The count of user logon
      type: Number
    - contextPath: MicrosoftATP.AlertUser.User.DomainAdmin
      description: True if domain admin, False otherwise
      type: Number
    - contextPath: MicrosoftATP.AlertUser.User.NetworkUser
      description: True if domain admin, False otherwise
      type: Number
    - contextPath: MicrosoftATP.AlertUser.AlertID
      description: The alert ID
      type: String
  - arguments:
    - description: ID of the alert.
      name: id
      required: true
    - defaultValue: "50"
      description: The limit of files to display
      name: limit
    - defaultValue: "0"
      description: The page from which to get the related files
      name: offset
    description: Retrieves the files associated to a specific alert.
    name: microsoft-atp-get-alert-related-files
    outputs:
    - contextPath: MicrosoftATP.AlertFile.Files.FilePublisher
      description: The file's publisher
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.Size
      description: The size of the file
      type: Number
    - contextPath: MicrosoftATP.AlertFile.Files.GlobalLastObserved
      description: The last time the file was observed
      type: Date
    - contextPath: MicrosoftATP.AlertFile.Files.Sha1
      description: The SHA1 hash of the file
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.IsValidCertificate
      description: Was signing certificate successfully verified by Microsoft Defender
        ATP agent.
      type: Number
    - contextPath: MicrosoftATP.AlertFile.Files.Sha256
      description: The SHA256 hash of the file
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.Signer
      description: The file signer
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.GlobalPrevalence
      description: The file prevalence across organization
      type: Number
    - contextPath: MicrosoftATP.AlertFile.Files.DeterminationValue
      description: The file determination value
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.GlobalFirstObserved
      description: The first time the file was observed
      type: Date
    - contextPath: MicrosoftATP.AlertFile.Files.FileType
      description: The type of the file
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.SignerHash
      description: The hash of the signing certificate
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.Issuer
      description: The file issuer
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.IsPeFile
      description: True if the file is portable executable, False otherwise
      type: Number
    - contextPath: MicrosoftATP.AlertFile.Files.DeterminationType
      description: The file determination type
      type: String
    - contextPath: MicrosoftATP.AlertFile.Files.FileProductName
      description: The file product name
      type: Unknown
    - contextPath: MicrosoftATP.AlertFile.Files.Md5
      description: The MD5 hash of the file
      type: String
  - arguments:
    - description: ID of the alert.
      name: id
      required: true
    - defaultValue: "50"
      description: The limit of IPs to display.
      name: limit
    - defaultValue: "0"
      description: The page from which to get the related IPs.
      name: offset
    description: Retrieves the IPs associated to a specific alert.
    name: microsoft-atp-get-alert-related-ips
    outputs:
    - contextPath: MicrosoftATP.AlertIP.IPs.IpAddress
      description: The address of the IP
      type: String
    - contextPath: MicrosoftATP.AlertIP.AlertID
      description: The alert ID
      type: String
  - arguments:
    - description: ID of the alert.
      name: id
      required: true
    - defaultValue: "50"
      description: The limit of domains to display.
      name: limit
    - defaultValue: "0"
      description: The page from which to get the related domains.
      name: offset
    description: Retrieves the domains associated to a specific alert.
    name: microsoft-atp-get-alert-related-domains
    outputs:
    - contextPath: MicrosoftATP.AlertDomain.Domains.Domain
      description: The domain address
      type: String
    - contextPath: MicrosoftATP.AlertDomain.AlertID
      description: The alert ID
      type: Unknown
  - arguments:
    - description: ID of the action.
      name: id
    - auto: PREDEFINED
      description: The machine action status.
      name: status
      predefined:
      - Pending
      - InProgress
      - Succeeded
      - Failed
      - TimeOut
      - ' Cancelled'
    - description: The machine ID on which the action was executed, only one can be
        added.
      name: machine_id
    - auto: PREDEFINED
      description: The machine action type.
      name: type
      predefined:
      - RunAntiVirusScan
      - Offboard
      - CollectInvestigationPackage
      - Isolate
      - Unisolate
      - StopAndQuarantineFile
      - RestrictCodeExecution
      - UnrestrictCodeExecution
    - description: The ID of the user that executed the action, only one can be added.
      name: requestor
    description: |-
      Return the machine's actions. If you set an action id it will return the info on the specific action.
      Filtering can be done only on one argument.
    name: microsoft-atp-list-machine-actions-details
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: The type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: The scope of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - description: The machine ID.
      name: machine_id
      required: true
    - description: Comment to associate with the action.
      name: comment
      required: true
    description: Collect an investigation package from a machine.
    name: microsoft-atp-collect-investigation-package
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: The type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: The scope of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action.
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action.
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed.
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - description: machine action ID.
      name: action_id
      required: true
    description: Get a URI that allows downloading an investigation package.
    name: microsoft-atp-get-investigation-package-sas-uri
    outputs:
    - contextPath: MicrosoftATP.InvestigationURI.Link
      description: The investigation package URI
      type: String
  - arguments:
    - description: The machine ID.
      name: machine_id
      required: true
    - description: Comment to associate with the action.
      name: comment
    description: Restrict the execution of all applications on the machine except
      a predefined set.
    name: microsoft-atp-restrict-app-execution
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: The type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: The scope of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - description: The machine ID.
      name: machine_id
      required: true
    - description: Comment to associate with the action.
      name: comment
      required: true
    description: Enable the execution of any application on the machine.
    name: microsoft-atp-remove-app-restriction
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: The type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: The scope of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - description: The machine ID.
      name: machine_id
      required: true
    - description: The file SHA1 hash to stop and quarantine on the machine.
      name: file_hash
      required: true
    - description: Comment to associate with the action.
      name: comment
      required: true
    description: Stop the execution of a file on a machine and delete it.
    name: microsoft-atp-stop-and-quarantine-file
    outputs:
    - contextPath: MicrosoftATP.MachineAction.ID
      description: The machine action ID
      type: String
    - contextPath: MicrosoftATP.MachineAction.Type
      description: The type of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Scope
      description: The scope of the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Requestor
      description: The ID of the user that executed the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.RequestorComment
      description: The comment that was written when issuing the action
      type: String
    - contextPath: MicrosoftATP.MachineAction.Status
      description: The current status of the command
      type: String
    - contextPath: MicrosoftATP.MachineAction.MachineID
      description: The machine ID on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.ComputerDNSName
      description: The machine DNS name on which the action was executed
      type: String
    - contextPath: MicrosoftATP.MachineAction.CreationDateTimeUtc
      description: The date and time when the action was created
      type: Date
    - contextPath: MicrosoftATP.MachineAction.LastUpdateTimeUtc
      description: The last date and time when the action status was updated
      type: Date
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifier
      description: The file identifier
      type: String
    - contextPath: MicrosoftATP.MachineAction.RelatedFileInfo.FileIdentifierType
      description: 'The type of the file identifier with the possible values: "SHA1"
        ,"SHA256" and "MD5"'
      type: String
  - arguments:
    - description: ID can be the investigation ID or the investigation triggering
        alert ID.
      name: id
    - defaultValue: "50"
      description: The limit of investigations to display.
      name: limit
    - defaultValue: "0"
      description: The page from which to get the investigations.
      name: offset
      predefined:
      - ""
    description: Retrieves a collection of investigations or retrieves specific investigation
      by its ID.
    name: microsoft-atp-list-investigations
    outputs:
    - contextPath: MicrosoftATP.Investigation.ID
      description: The investigation ID
      type: String
    - contextPath: MicrosoftATP.Investigation.StartTime
      description: The date and time when the investigation was created
      type: Date
    - contextPath: MicrosoftATP.Investigation.EndTime
      description: The date and time when the investigation was completed
      type: Date
    - contextPath: MicrosoftATP.Investigation.State
      description: The investigation state
      type: String
    - contextPath: MicrosoftATP.Investigation.CancelledBy
      description: The ID of the user/application that cancelled that investigation
      type: Unknown
    - contextPath: MicrosoftATP.Investigation.StatusDetails
      description: The details about the investigation state
      type: Unknown
    - contextPath: MicrosoftATP.Investigation.MachineID
      description: The machine ID on which the investigation is executed
      type: String
    - contextPath: MicrosoftATP.Investigation.ComputerDNSName
      description: The machine DNS name on which the investigation is executed
      type: String
    - contextPath: MicrosoftATP.Investigation.TriggeringAlertID
      description: The alert ID that triggered the investigation
      type: String
  - arguments:
    - description: The machine's ID.
      name: machine_id
      required: true
    - description: Comment to associate with the action.
      name: comment
      required: true
    description: Start an automated investigation on a machine.
    name: microsoft-atp-start-investigation
    outputs:
    - contextPath: MicrosoftATP.Investigation.ID
      description: The investigation ID
      type: String
    - contextPath: MicrosoftATP.Investigation.StartTime
      description: The date and time when the investigation was created
      type: Date
    - contextPath: MicrosoftATP.Investigation.EndTime
      description: The date and time when the investigation was completed
      type: Date
    - contextPath: MicrosoftATP.Investigation.State
      description: The investigation state
      type: String
    - contextPath: MicrosoftATP.Investigation.CancelledBy
      description: The ID of the user/application that cancelled that investigation
      type: Unknown
    - contextPath: MicrosoftATP.Investigation.StatusDetails
      description: The details about the investigation state
      type: Unknown
    - contextPath: MicrosoftATP.Investigation.MachineID
      description: The machine ID on which the investigation is executed
      type: String
    - contextPath: MicrosoftATP.Investigation.ComputerDNSName
      description: The machine DNS name on which the investigation is executed
      type: String
    - contextPath: MicrosoftATP.Investigation.TriggeringAlertID
      description: The alert ID that triggered the investigation
      type: String
  - arguments:
    - description: The domain address
      name: domain
      required: true
    description: Retrieves the statistics on the given domain.
    name: microsoft-atp-get-domain-statistics
    outputs:
    - contextPath: MicrosoftATP.DomainStatistics.Statistics.Host
      description: The domain host
      type: String
    - contextPath: MicrosoftATP.DomainStatistics.Statistics.OrgPrevalence
      description: The prevalnce of the domain in the organizetion
      type: String
    - contextPath: MicrosoftATP.DomainStatistics.Statistics.OrgFirstSeen
      description: The first date and time the domain was in the organizetion
      type: Date
    - contextPath: MicrosoftATP.DomainStatistics.Statistics.OrgLastSeen
      description: The last date and time the domain was in the organizetion
      type: Date
  - arguments:
    - description: The domain address.
      name: domain
      required: true
    description: Retrieves a collection of alerts related to a given domain address.
    name: microsoft-atp-get-domain-alerts
    outputs:
    - contextPath: MicrosoftATP.DomainAlert.Domain
      description: The domain address
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.IncidentID
      description: The incident ID of the alert
      type: Number
    - contextPath: MicrosoftATP.DomainAlert.Alerts.InvestigationID
      description: The investigation ID related to the alert
      type: Number
    - contextPath: MicrosoftATP.DomainAlert.Alerts.InvestigationState
      description: The current state of the investigation
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Classification
      description: The alert classification
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.ThreatFamilyName
      description: The threat family name
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.DomainAlert.Alerts.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.DomainAlert.Alerts.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.DomainAlert.Alerts.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.DomainAlert.Alerts.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.DomainAlert.Alerts.MachineID
      description: The mahine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Comments.Comment
      description: The alert comment string
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.DomainAlert.Alerts.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - description: The domain address
      name: domain
      required: true
    description: Retrieves a collection of machines that have communicated to or from
      a given domain address.
    name: microsoft-atp-get-domain-machines
    outputs:
    - contextPath: MicrosoftATP.DomainMachine.Domain
      description: The domain address
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.ID
      description: The machine ID
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.FirstSeen
      description: The first date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.DomainMachine.Machines.LastSeen
      description: The last date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.DomainMachine.Machines.OSPlatform
      description: The operating system platform
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.OSVersion
      description: The operating system Version
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.OSProcessor
      description: The operating system processor
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.LastIPAddress
      description: The last IP on the machine
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.LastExternalIPAddress
      description: The last IP through which the machine accessed the internet
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.OSBuild
      description: The operating system build number
      type: Number
    - contextPath: MicrosoftATP.DomainMachine.Machines.HealthStatus
      description: The machine health status
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.RBACGroupID
      description: The machine RBAC group ID
      type: Number
    - contextPath: MicrosoftATP.DomainMachine.Machines.RBACGroupName
      description: The machine RBAC group Name
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.RiskScore
      description: The machine risk score
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.ExposureLevel
      description: The machine exposure level
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.IsAADJoined
      description: True if machine is AAD joined, False otherwise
      type: Boolean
    - contextPath: MicrosoftATP.DomainMachine.Machines.AADDeviceID
      description: The AAD Device ID
      type: String
    - contextPath: MicrosoftATP.DomainMachine.Machines.MachineTags
      description: Set of machine tags
      type: String
  - arguments:
    - description: File SHA1 hash to get statistics on.
      name: file_hash
      required: true
    description: Retrieves the statistics for the given file.
    name: microsoft-atp-get-file-statistics
    outputs:
    - contextPath: MicrosoftATP.FileStatistics.Sha1
      description: The file SHA1 hash
      type: String
    - contextPath: MicrosoftATP.FileStatistics.Statistics.OrgPrevalence
      description: The prevalnce of the file in the organizetion
      type: String
    - contextPath: MicrosoftATP.FileStatistics.Statistics.OrgFirstSeen
      description: The first date and time the file was in the organizetion
      type: Date
    - contextPath: MicrosoftATP.FileStatistics.Statistics.OrgLastSeen
      description: The last date and time the file was in the organizetion
      type: Date
    - contextPath: MicrosoftATP.FileStatistics.Statistics.GlobalPrevalence
      description: The global prevalnce of the file
      type: String
    - contextPath: MicrosoftATP.FileStatistics.Statistics.GlobalFirstObserved
      description: The global first observetion date and time of the file
      type: Date
    - contextPath: MicrosoftATP.FileStatistics.Statistics.GlobalLastObserved
      description: The global last observetion date and time of the file
      type: Date
    - contextPath: MicrosoftATP.FileStatistics.Statistics.TopFileNames
      description: The file's top names
      type: String
  - arguments:
    - description: File SHA1 hash to get statistics on.
      name: file_hash
      required: true
    description: Retrieves a collection of alerts related to a given file hash.
    name: microsoft-atp-get-file-alerts
    outputs:
    - contextPath: MicrosoftATP.FileAlert.Sha1
      description: The file SHA1 hash
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.IncidentID
      description: The Incident ID of the Alert
      type: Number
    - contextPath: MicrosoftATP.FileAlert.Alerts.InvestigationID
      description: The Investigation ID related to the Alert
      type: Number
    - contextPath: MicrosoftATP.FileAlert.Alerts.InvestigationState
      description: The current state of the Investigation
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Classification
      description: The alert Classification
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.ThreatFamilyName
      description: The threat family name
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.FileAlert.Alerts.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.FileAlert.Alerts.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.FileAlert.Alerts.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.FileAlert.Alerts.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.FileAlert.Alerts.MachineID
      description: The mahine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Comments.Comment
      description: The alert comment string
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.FileAlert.Alerts.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - description: The IP address.
      name: ip
      required: true
    description: Retrieves the statistics for the given IP.
    name: microsoft-atp-get-ip-statistics
    outputs:
    - contextPath: MicrosoftATP.IPStatistics.Statistics.IPAddress
      description: The IP address
      type: String
    - contextPath: MicrosoftATP.IPStatistics.Statistics.OrgPrevalence
      description: The prevalnce of the IP on the organizetion
      type: String
    - contextPath: MicrosoftATP.IPStatistics.Statistics.OrgFirstSeen
      description: The first date and time the IP was in the organizetion
      type: Date
    - contextPath: MicrosoftATP.IPStatistics.Statistics.OrgLastSeen
      description: The last date and time the IP was in the organizetion
      type: Date
  - arguments:
    - description: The Ip address.
      name: ip
      required: true
    description: Retrieves a collection of alerts related to a given IP address.
    name: microsoft-atp-get-ip-alerts
    outputs:
    - contextPath: MicrosoftATP.IPAlert.IPAddress
      description: The IP address
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.IncidentID
      description: The incident ID of the alert
      type: Number
    - contextPath: MicrosoftATP.IPAlert.Alerts.InvestigationID
      description: The investigation ID related to the alert
      type: Number
    - contextPath: MicrosoftATP.IPAlert.Alerts.InvestigationState
      description: The current state of the investigation
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Classification
      description: The alert classification
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.ThreatFamilyName
      description: The threat family name
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.IPAlert.Alerts.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.IPAlert.Alerts.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.IPAlert.Alerts.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.IPAlert.Alerts.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.IPAlert.Alerts.MachineID
      description: The machine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Comments.Comment
      description: The alert comment string
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.IPAlert.Alerts.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - description: |-
        The user ID.  Note that the ID is not the full UPN, but only the user name.
         (e.g., to retrieve alerts foruser1@test.comuse user1)
      name: username
      required: true
    description: Retrieves a collection of alerts related to a given user ID.
    name: microsoft-atp-get-user-alerts
    outputs:
    - contextPath: MicrosoftATP.UserAlert.Username
      description: The user name
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.ID
      description: The alert ID
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.IncidentID
      description: The incident ID of the alert
      type: Number
    - contextPath: MicrosoftATP.UserAlert.Alerts.InvestigationID
      description: The investigation ID related to the alert
      type: Number
    - contextPath: MicrosoftATP.UserAlert.Alerts.InvestigationState
      description: The current state of the investigation
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.AssignedTo
      description: The owner of the alert
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Severity
      description: The severity of the alert
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Status
      description: The current status of the alert
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Classification
      description: The alert classification
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Determination
      description: The determination of the alert
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.DetectionSource
      description: The detection source
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Category
      description: The category of the alert
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.ThreatFamilyName
      description: The threat family name
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Title
      description: The alert title
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Description
      description: The alert description
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.AlertCreationTime
      description: The date and time the alert was created
      type: Date
    - contextPath: MicrosoftATP.UserAlert.Alerts.FirstEventTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.UserAlert.Alerts.LastEventTime
      description: The last event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.UserAlert.Alerts.LastUpdateTime
      description: The first event time that triggered the alert on that machine
      type: Date
    - contextPath: MicrosoftATP.UserAlert.Alerts.ResolvedTime
      description: The date and time in which the status of the alert was changed
        to 'Resolved'
      type: Date
    - contextPath: MicrosoftATP.UserAlert.Alerts.MachineID
      description: The mahine ID that is associated with the alert
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.AADTenantID
      description: The AAD tenant ID
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Comments.Comment
      description: The alert comment string
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Comments.CreatedBy
      description: The alert comment created by string
      type: String
    - contextPath: MicrosoftATP.UserAlert.Alerts.Comments.CreatedTime
      description: The alert comment create time date
      type: Date
  - arguments:
    - description: |-
        The user ID.  Note that the id is not the full UPN, but only the user name.
        (e.g., to retrieve machines foruser1@test.comuse user1)
      name: username
      required: true
    description: Retrieves a collection of machines related to a given user ID.
    name: microsoft-atp-get-user-machines
    outputs:
    - contextPath: MicrosoftATP.UserMachine.Username
      description: The user name
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.ID
      description: The machine ID
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.FirstSeen
      description: The first date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.UserMachine.Machines.LastSeen
      description: The last date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.UserMachine.Machines.OSPlatform
      description: The operating system platform
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.OSVersion
      description: The operating system Version
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.OSProcessor
      description: The operating system processor
      type: String
    - contextPath: MicrosoftATP.v.Machines.LastIPAddress
      description: The last IP on the machine
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.LastExternalIPAddress
      description: The last IP through which the machine accessed the internet
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.OSBuild
      description: The operating system build number
      type: Number
    - contextPath: MicrosoftATP.UserMachine.Machines.HealthStatus
      description: The machine health status
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.RBACGroupID
      description: The machine RBAC group ID
      type: Number
    - contextPath: MicrosoftATP.UserMachine.Machines.RBACGroupName
      description: The machine RBAC group Name
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.RiskScore
      description: The machine risk score
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.ExposureLevel
      description: The machine exposure level
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.IsAADJoined
      description: True if machine is AAD joined, False otherwise
      type: Boolean
    - contextPath: MicrosoftATP.UserMachine.Machines.AADDeviceID
      description: The AAD device ID
      type: String
    - contextPath: MicrosoftATP.UserMachine.Machines.MachineTags
      description: Set of machine tags
      type: String
  - arguments:
    - description: The machine ID.
      name: machine_id
      required: true
    - auto: PREDEFINED
      description: The action to use for the tag.
      name: action
      predefined:
      - Add
      - Remove
      required: true
    - description: The tag name.
      name: tag
      required: true
    description: Adds or removes a tag on a specific Machine.
    name: microsoft-atp-add-remove-machine-tag
    outputs:
    - contextPath: MicrosoftATP.Machine.ID
      description: The machine ID
      type: String
    - contextPath: MicrosoftATP.Machine.ComputerDNSName
      description: The machine DNS name
      type: String
    - contextPath: MicrosoftATP.Machine.FirstSeen
      description: The first date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.Machine.LastSeen
      description: The last date and time where the machine was observed by Microsoft
        Defender ATP
      type: Date
    - contextPath: MicrosoftATP.Machine.OSPlatform
      description: The operating system platform
      type: String
    - contextPath: MicrosoftATP.Machine.OSVersion
      description: The operating system Version
      type: String
    - contextPath: MicrosoftATP.Machine.OSProcessor
      description: The operating system processor
      type: String
    - contextPath: MicrosoftATP.Machine.LastIPAddress
      description: The last IP on the machine
      type: String
    - contextPath: MicrosoftATP.Machine.LastExternalIPAddress
      description: The last IP through which the machine accessed the internet
      type: String
    - contextPath: MicrosoftATP.Machine.OSBuild
      description: The operating system build number
      type: Number
    - contextPath: MicrosoftATP.Machine.HealthStatus
      description: The machine health status
      type: String
    - contextPath: MicrosoftATP.Machine.RBACGroupID
      description: The machine RBAC group ID
      type: Number
    - contextPath: MicrosoftATP.Machine.RBACGroupName
      description: The machine RBAC group Name
      type: String
    - contextPath: MicrosoftATP.Machine.RiskScore
      description: The machine risk score
      type: String
    - contextPath: MicrosoftATP.Machine.ExposureLevel
      description: The machine exposure level
      type: String
    - contextPath: MicrosoftATP.Machine.IsAADJoined
      description: True if machine is AAD joined, False otherwise
      type: Boolean
    - contextPath: MicrosoftATP.Machine.AADDeviceID
      description: The AAD device ID
      type: String
    - contextPath: MicrosoftATP.Machine.MachineTags
      description: Set of machine tags
      type: String
  dockerimage: demisto/crypto:1.0.0.303
  isfetch: true
  runonce: false
  script: |2



    import requests
    import base64
    from dateutil.parser import parse
    from cryptography.hazmat.primitives.ciphers.aead import AESGCM
    requests.packages.urllib3.disable_warnings()

    try:
        handle_proxy()
    except Exception as e:
        return_error('An error has occurred in the Microsoft Defender Advanced Threat Protection integration:'
                     ' {err}'.format(err=str(e)))


    ''' GLOBAL VARS '''

    SERVER = demisto.params()['url'][:-1] if demisto.params()['url'].endswith('/') else demisto.params()['url']
    BASE_URL = SERVER + '/api'
    TENANT_ID = demisto.params()['tenant_id']
    AUTH_AND_TOKEN_URL = demisto.params()['auth_id'].split('@')
    AUTH_ID = AUTH_AND_TOKEN_URL[0]
    ENC_KEY = demisto.params()['enc_key']
    USE_SSL = not demisto.params().get('insecure', False)
    ALERT_SEVERITIES_TO_FETCH = demisto.params()['fetch_severity']
    ALERT_STATUS_TO_FETCH = demisto.params().get('fetch_status')
    ALERT_TIME_TO_FETCH = demisto.params().get('first_fetch_timestamp', '3 days')

    if len(AUTH_AND_TOKEN_URL) != 2:
        TOKEN_RETRIEVAL_URL = 'https://oproxy.demisto.ninja/obtain-token'  # guardrails-disable-line disable-secrets-detection
    else:
        TOKEN_RETRIEVAL_URL = AUTH_AND_TOKEN_URL[1]
    APP_NAME = 'ms-defender-atp'

    ''' HELPER FUNCTIONS '''


    def epoch_seconds(d=None):
        """
        Return the number of seconds for given date. If no date, return current.
        """
        if not d:
            d = datetime.utcnow()
        return int((d - datetime.utcfromtimestamp(0)).total_seconds())


    def get_encrypted(content: str, key: str) -> str:
        """
        Args:
            content (str): content to encrypt. For a request to Demistobot for a new access token, content should be
                the tenant id
            key (str): encryption key from Demistobot

        Returns:
            encrypted timestamp:content
        """
        def create_nonce() -> bytes:
            return os.urandom(12)

        def encrypt(string: str, enc_key: str) -> bytes:
            """
            Args:
                enc_key (str):
                string (str):

            Returns:
                bytes:
            """
            # String to bytes
            enc_key = base64.b64decode(enc_key)
            # Create key
            aes_gcm = AESGCM(enc_key)
            # Create nonce
            nonce = create_nonce()
            # Create ciphered data
            data = string.encode()
            ct = aes_gcm.encrypt(nonce, data, None)
            return base64.b64encode(nonce + ct)
        now = epoch_seconds()
        encrypted = encrypt(f'{now}:{content}', key).decode('utf-8')
        return encrypted


    def get_access_token():
        integration_context = demisto.getIntegrationContext()
        access_token = integration_context.get('access_token')
        valid_until = integration_context.get('valid_until')
        calling_context = demisto.callingContext.get('context', {})  # type: ignore[attr-defined]
        brand_name = calling_context.get('IntegrationBrand', '')
        instance_name = calling_context.get('IntegrationInstance', '')
        if access_token and valid_until:
            if epoch_seconds() < valid_until:
                return access_token
        headers = {'Accept': 'application/json'}
        headers['X-Content-Version'] = CONTENT_RELEASE_VERSION
        headers['X-Branch-Name'] = CONTENT_BRANCH_NAME
        headers['X-Content-Name'] = brand_name or instance_name or 'Name not found'

        dbot_response = requests.post(
            TOKEN_RETRIEVAL_URL,
            headers=headers,
            data=json.dumps({
                'app_name': APP_NAME,
                'registration_id': AUTH_ID,
                'encrypted_token': get_encrypted(TENANT_ID, ENC_KEY)
            }),
            verify=USE_SSL
        )
        if dbot_response.status_code not in {200, 201}:
            msg = 'Error in authentication. Try checking the credentials you entered.'
            try:
                demisto.info('Authentication failure from server: {} {} {}'.format(
                    dbot_response.status_code, dbot_response.reason, dbot_response.text))
                err_response = dbot_response.json()
                server_msg = err_response.get('message')
                if not server_msg:
                    title = err_response.get('title')
                    detail = err_response.get('detail')
                    if title:
                        server_msg = f'{title}. {detail}'
                if server_msg:
                    msg += ' Server message: {}'.format(server_msg)
            except Exception as ex:
                demisto.error('Failed parsing error response - Exception: {}'.format(ex))
            raise Exception(msg)
        try:
            gcloud_function_exec_id = dbot_response.headers.get('Function-Execution-Id')
            demisto.info(f'Google Cloud Function Execution ID: {gcloud_function_exec_id}')
            parsed_response = dbot_response.json()
        except ValueError:
            raise Exception(
                'There was a problem in retrieving an updated access token.\n'
                'The response from the Demistobot server did not contain the expected content.'
            )
        access_token = parsed_response.get('access_token')
        expires_in = parsed_response.get('expires_in', 3595)
        time_now = epoch_seconds()
        time_buffer = 5  # seconds by which to shorten the validity period
        if expires_in - time_buffer > 0:
            # err on the side of caution with a slightly shorter access token validity period
            expires_in = expires_in - time_buffer

        demisto.setIntegrationContext({
            'access_token': access_token,
            'valid_until': time_now + expires_in
        })
        return access_token


    def http_request(method, url_suffix, json=None, data=None, params=None):

        token = get_access_token()
        r = requests.request(
            method,
            BASE_URL + url_suffix,
            json=json,
            headers={
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            verify=USE_SSL,
            data=data

        )
        if r.status_code not in {200, 201}:
            try:
                error = r.json().get('error')
                msg = error['message'] if 'message' in error else r.reason
                return_error('Error in API call to ATP [%d] - %s' % (r.status_code, r.text))
            except ValueError:
                msg = r.text if r.text else r.reason
                return_error('Error in API call to ATP [%d] - %s' % (r.status_code, msg))
        if not r.text:
            return {}
        try:
            return r.json()
        except ValueError:
            return {}


    def alert_to_incident(alert, alert_creation_time):
        incident = {
            'rawJSON': json.dumps(alert),
            'name': 'Microsoft Defender ATP Alert ' + alert['id'],
            'occurred': alert_creation_time.isoformat() + 'Z'
        }

        return incident


    ''' REQUESTS '''


    def isolate_machine_request(machine_id, comment, isolation_type):
        """Isolates a machine from accessing external network.

        Args:
            machine_id (str): Machine ID
            comment (str): Comment to associate with the action.
            isolation_type (str): Type of the isolation.

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action
        """
        cmd_url = '/machines/{}/isolate'.format(machine_id)
        json = {
            "Comment": comment,
            "IsolationType": isolation_type
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def unisolate_machine_request(machine_id, comment):
        """Undo isolation of a machine.

        Args:
            machine_id (str): Machine ID
            comment (str): Comment to associate with the action.

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action
        """
        cmd_url = '/machines/{}/unisolate'.format(machine_id)
        json = {
            'Comment': comment
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def get_machines_request(filter_req):
        """Retrieves a collection of Machines that have communicated with Microsoft Defender ATP cloud on the last 30 days.

        Returns:
            dict. Machine's info
        """
        cmd_url = '/machines'
        if filter_req:
            cmd_url += f'?$filter={filter_req}'
        response = http_request('GET', cmd_url)
        return response


    def get_file_related_machines_request(file):
        """Retrieves a collection of Machines related to a given file hash.

        Args:
            file (str): File's hash

        Returns:
            dict. Related machines
        """
        cmd_url = '/files/{}/machines'.format(file)
        response = http_request('GET', cmd_url)
        return response


    def get_machine_details_request(machine_id):
        """Retrieves specific Machine by its machine ID.

        Args:
            machine_id (str): Machine ID

        Returns:
            dict. Machine's info
        """
        cmd_url = '/machines/{}'.format(machine_id)
        response = http_request('GET', cmd_url)
        return response


    def run_antivirus_scan_request(machine_id, comment, scan_type):
        """Initiate Windows Defender Antivirus scan on a machine.

        Args:
            machine_id (str): Machine ID
            comment (str):     Comment to associate with the action
            scan_type (str): Defines the type of the Scan (Quick, Full)

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action
        """
        cmd_url = '/machines/{}/runAntiVirusScan'.format(machine_id)
        json = {
            'Comment': comment,
            'ScanType': scan_type
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def list_alerts_request(filter_req=None):
        """Retrieves a collection of Alerts.

        Returns:
            dict. Alerts info
        """
        cmd_url = '/alerts'
        if filter_req:
            cmd_url += f'?$filter={filter_req}'
        response = http_request('GET', cmd_url)
        return response


    def update_alert_request(alert_id, json):
        """Updates properties of existing Alert.

        Returns:
            dict. Alerts info
        """
        cmd_url = '/alerts/{}'.format(alert_id)
        response = http_request('PATCH', cmd_url, json=json)
        return response


    def get_advanced_hunting_request(query):
        """Retrieves results according to query.

        Args:
            query (str): Query to do advanced hunting on

        Returns:
            dict. Advanced hunting results
        """
        cmd_url = '/advancedqueries/run'
        json = {
            'Query': query
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def create_alert(machine_id, severity, title, description, event_time, report_id, rec_action, category):
        """Creates new Alert on top of Event.

        Args:
            machine_id (str): ID of the machine on which the event was identified
            severity (str): Severity of the alert
            title (str): Title for the alert
            description (str): Description of the alert
            event_time (str): The precise time of the event as string
            report_id (str): The reportId of the event
            rec_action (str): Action that is recommended to be taken by security officer when analyzing the alert
            category (Str): Category of the alert

        Returns:
            dict. Related domains
        """
        cmd_url = '/alerts/CreateAlertByReference'
        json = {
            'machineId': machine_id,
            'severity': severity,
            'title': title,
            'description': description,
            'eventTime': event_time,
            'reportId': report_id,
            'recommendedAction': rec_action,
            'category': category
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def get_alert_related_domains_request(alert_id):
        """Retrieves all domains related to a specific alert.

        Args:
            alert_id (str): Alert ID

        Returns:
            dict. Related domains
        """
        cmd_url = '/alerts/{}/domains'.format(alert_id)
        response = http_request('GET', cmd_url)
        return response


    def get_alert_related_files_request(alert_id):
        """Retrieves all files related to a specific alert.

        Args:
            alert_id (str): Alert ID

        Returns:
            dict. Related files
        """
        cmd_url = '/alerts/{}/files'.format(alert_id)
        response = http_request('GET', cmd_url)
        return response


    def get_alert_related_ips_request(alert_id):
        """Retrieves all IPs related to a specific alert.

        Args:
            alert_id (str): Alert ID

        Returns:
            dict. Related IPs
        """
        cmd_url = '/alerts/{}/ips'.format(alert_id)
        response = http_request('GET', cmd_url)
        return response


    def get_alert_related_user_request(alert_id):
        """Retrieves the User related to a specific alert.

        Args:
            alert_id (str): Alert ID

        Returns:
            dict. Related user
        """
        cmd_url = '/alerts/{}/user'.format(alert_id)
        response = http_request('GET', cmd_url)
        return response


    def get_machine_action_by_id_request(action_id):
        """Retrieves specific Machine Action by its ID.

        Args:
            action_id (str): Action ID

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine Action entity
        """
        cmd_url = '/machineactions/{}'.format(action_id)
        response = http_request('GET', cmd_url)
        return response


    def get_machine_actions_request(filter_req):
        """Retrieves all Machine Actions.

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine Action entity
        """
        cmd_url = '/machineactions'
        if filter_req:
            cmd_url += f'?$filter={filter_req}'
        response = http_request('GET', cmd_url)
        return response


    def get_investigation_package_request(machine_id, comment):
        """Collect investigation package from a machine.

        Args:
            machine_id (str): Machine ID
            comment (str): Comment to associate with the action
        Returns:

            dict. Machine's investigation_package
        """
        cmd_url = '/machines/{}/collectInvestigationPackage'.format(machine_id)
        json = {
            'Comment': comment
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def get_investigation_package_sas_uri_request(action_id):
        """Get a URI that allows downloading of an Investigation package.

        Args:
            action_id (str): Action ID

        Returns:
            dict. An object that holds the link for the package
        """
        cmd_url = '/machineactions/{}/getPackageUri'.format(action_id)
        response = http_request('GET', cmd_url)
        return response


    def restrict_app_execution_request(machine_id, comment):
        """Restrict execution of all applications on the machine except a predefined set.

        Args:
            machine_id (str): Machine ID
            comment (str): Comment to associate with the action

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action
        """
        cmd_url = '/machines/{}/restrictCodeExecution'.format(machine_id)
        json = {
            'Comment': comment
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def remove_app_restriction_request(machine_id, comment):
        """Enable execution of any application on the machine.

        Args:
            machine_id (str): Machine ID
            comment (str): Comment to associate with the action

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action
        """
        cmd_url = '/machines/{}/unrestrictCodeExecution'.format(machine_id)
        json = {
            'Comment': comment
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def stop_and_quarantine_file_request(machine_id, file_sha1, comment):
        """Stop execution of a file on a machine and delete it.

        Args:
            machine_id (str): Machine ID
            file_sha1: (str): File's hash
            comment (str): Comment to associate with the action

        Notes:
            Machine action is a collection of actions you can apply on the machine, for more info
            https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action
        """
        cmd_url = '/machines/{}/stopAndQuarantineFile'.format(machine_id)
        json = {
            'Comment': comment,
            'Sha1': file_sha1
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def get_investigation_by_id_request(investigation_id):
        """Get the investigation ID and return the investigation details.

        Args:
            investigation_id (str): The investigation ID

        Returns:
            dict. Investigations entity
        """
        cmd_url = '/investigations/{}'.format(investigation_id)
        response = http_request('GET', cmd_url)
        return response


    def get_alert_by_id_request(alert_id):
        """Get the alert ID and return the alert details.

        Args:
            alert_id (str): The alert ID

        Returns:
            dict. Alert's entity
        """
        cmd_url = '/alerts/{}'.format(alert_id)
        response = http_request('GET', cmd_url)
        return response


    def get_investigation_list_request():
        """Retrieves a collection of Investigations.

        Returns:
            dict. A collection of Investigations entities.
        """
        cmd_url = '/investigations'
        response = http_request('GET', cmd_url)
        return response


    def start_investigation_request(machine_id, comment):
        """Start automated investigation on a machine.

        Args:
            machine_id (str): The Machine ID
            comment (str): Comment to associate with the action

        Returns:
            dict. Investigation's entity
        """
        cmd_url = '/machines/{}/startInvestigation'.format(machine_id)
        json = {
            'Comment': comment,
        }
        response = http_request('POST', cmd_url, json=json)
        return response


    def get_domain_statistics_request(domain):
        """Retrieves the statistics on the given domain.

        Args:
            domain (str): The Domain's address

        Returns:
            dict. Domain's statistics
        """
        cmd_url = '/domains/{}/stats'.format(domain)
        response = http_request('GET', cmd_url)
        return response


    def get_file_statistics_request(file_sha1):
        """Retrieves the statistics on the given file.

        Args:
            file_sha1 (str): The file's hash

        Returns:
            dict. File's statistics
        """
        cmd_url = '/files/{}/stats'.format(file_sha1)
        response = http_request('GET', cmd_url)
        return response


    def get_ip_statistics_request(ip):
        """Retrieves the statistics on the given IP.

        Args:
            ip (str): The IP address

        Returns:
            dict. IP's statistics
        """
        cmd_url = '/ips/{}/stats'.format(ip)
        response = http_request('GET', cmd_url)
        return response


    def get_domain_alerts_request(domain):
        """Retrieves a collection of Alerts related to a given domain address.

        Args:
            domain (str): The Domain's address

        Returns:
            dict. Alerts entities
        """
        cmd_url = '/domains/{}/alerts'.format(domain)
        response = http_request('GET', cmd_url)
        return response


    def get_file_alerts_request(file_sha1):
        """Retrieves a collection of Alerts related to a given file hash.

        Args:
            file_sha1 (str): The file's hash

        Returns:
            dict. Alerts entities
        """
        cmd_url = '/files/{}/alerts'.format(file_sha1)
        response = http_request('GET', cmd_url)
        return response


    def get_ip_alerts_request(ip):
        """Retrieves a collection of Alerts related to a given IP.

        Args:
            ip (str): The IP address

        Returns:
            dict. Alerts entities
        """
        cmd_url = '/ips/{}/alerts'.format(ip)
        response = http_request('GET', cmd_url)
        return response


    def get_user_alerts_request(username):
        """Retrieves a collection of Alerts related to a given  user ID.

        Args:
            username (str): The user ID

        Returns:
            dict. Alerts entities
        """
        cmd_url = '/users/{}/alerts'.format(username)
        response = http_request('GET', cmd_url)
        return response


    def get_domain_machines_request(domain):
        """Retrieves a collection of Machines that have communicated to or from a given domain address.

        Args:
            domain (str): The Domain's address

        Returns:
            dict. Machines entities
        """
        cmd_url = '/domains/{}/machines'.format(domain)
        response = http_request('GET', cmd_url)
        return response


    def get_user_machines_request(username):
        """Retrieves a collection of machines related to a given user ID.

        Args:
            username (str): The user name

        Returns:
            dict. Machines entities
        """
        cmd_url = '/users/{}/machines'.format(username)
        response = http_request('GET', cmd_url)
        return response


    def add_remove_machine_tag_request(machine_id, action, tag):
        """Retrieves a collection of machines related to a given user ID.

        Args:
            machine_id (str): The machine ID
            action (str): Add or Remove action
            tag (str): The tag name

        Returns:
            dict. Updated machine's entity
        """
        cmd_url = '/machines/{}/tags'.format(machine_id)
        new_tags = {
            "Value": tag,
            "Action": action
        }
        response = http_request('POST', cmd_url, json=new_tags)
        return response


    def get_file_data_request(file_hash):
        """Retrieves a File by identifier SHA1.

        Args:
            file_hash(str): The file SHA1 hash

        Returns:
            dict. File entities
        """
        cmd_url = '/files/{}'.format(file_hash)
        response = http_request('GET', cmd_url)
        return response


    ''' Commands '''


    def get_alert_related_user_command():
        """Retrieves the User related to a specific alert.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        alert_id = demisto.args().get('id')
        response = get_alert_related_user_request(alert_id)

        user_data = get_user_data(response)
        context_output = {
            'AlertID': alert_id,
            'User': user_data
        }
        ec = {
            'MicrosoftATP.AlertUser(val.AlertID === obj.AlertID)': context_output
        }

        hr = tableToMarkdown('Alert Related User:', user_data, removeNull=True)
        return hr, ec, response


    def get_user_data(user_response):
        """Get the user raw response and returns the user info in context and human readable format

        Returns:
            dict. User data
        """
        user_data = {
            'ID': user_response.get('id'),
            'AccountName': user_response.get('accountName'),
            'AccountDomain': user_response.get('accountDomain'),
            'AccountSID': user_response.get('accountSid'),
            'FirstSeen': user_response.get('firstSeen'),
            'LastSeen': user_response.get('lastSeen'),
            'MostPrevalentMachineID': user_response.get('mostPrevalentMachineId'),
            'LeastPrevalentMachineID': user_response.get('leastPrevalentMachineId'),
            'LogonTypes': user_response.get('logonTypes'),
            'LogonCount': user_response.get('logOnMachinesCount'),
            'DomainAdmin': user_response.get('isDomainAdmin'),
            'NetworkUser': user_response.get('isOnlyNetworkUser')
        }
        return user_data


    def isolate_machine_command():
        """Isolates a machine from accessing external network.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']

        machine_id = demisto.args().get('machine_id')
        comment = demisto.args().get('comment')
        isolation_type = demisto.args().get('isolation_type')
        machine_action_response = isolate_machine_request(machine_id, comment, isolation_type)
        machine_action_data = get_machine_action_data(machine_action_response)

        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': machine_action_data
        }
        human_readable = tableToMarkdown("The isolation request has been submitted successfully:", machine_action_data,
                                         headers=headers, removeNull=True)
        return human_readable, entry_context, machine_action_response


    def unisolate_machine_command():
        """Undo isolation of a machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        machine_id = demisto.args().get('machine_id')
        comment = demisto.args().get('comment')
        machine_action_response = unisolate_machine_request(machine_id, comment)
        machine_action_data = get_machine_action_data(machine_action_response)

        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': machine_action_data
        }

        human_readable = tableToMarkdown("The request to stop the isolation has been submitted successfully:",
                                         machine_action_data, headers=headers, removeNull=True)
        return human_readable, entry_context, machine_action_response


    def get_machines_command():
        """Retrieves a collection of machines that have communicated with WDATP cloud on the last 30 days

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'ComputerDNSName', 'OSPlatform', 'LastIPAddress', 'LastExternalIPAddress', 'HealthStatus',
                   'RiskScore', 'ExposureLevel']
        hostname = demisto.args().get('hostname', '')
        ip = demisto.args().get('ip', '')
        risk_score = demisto.args().get('risk_score', '')
        health_status = demisto.args().get('health_status', '')
        os_platform = demisto.args().get('os_platform', '')

        fields_to_filter_by = {
            'computerDnsName': hostname,
            'lastIpAddress': ip,
            'riskScore': risk_score,
            'healthStatus': health_status,
            'osPlatform': os_platform
        }
        filter_req = reformat_filter(fields_to_filter_by)
        machines_response = get_machines_request(filter_req)
        machines_list = get_machines_list(machines_response)

        entry_context = {
            'MicrosoftATP.Machine(val.ID === obj.ID)': machines_list
        }
        human_readable = tableToMarkdown('Microsoft Defender ATP Machines:', machines_list, headers=headers,
                                         removeNull=True)
        return human_readable, entry_context, machines_response


    def get_machines_list(machines_response):
        """Get a raw response of machines list

        Args:
            machines_response (dict): The raw response with the machines list in it

        Returns:
            list. Machines list
        """
        machines_list = []
        for machine in machines_response['value']:
            machine_data = get_machine_data(machine)
            machines_list.append(machine_data)
        return machines_list


    def reformat_filter(fields_to_filter_by):
        """Get a dictionary with all of the fields to filter

        Args:
            fields_to_filter_by (dict): Dictionary with all the fields to filter

        Returns:
            string. Filter to send in the API request
        """
        filter_req = ''
        for field_key, field_value in fields_to_filter_by.items():
            if field_value:
                filter_req += f"{field_key}+eq+'{field_value}'&"
        return filter_req


    def get_file_related_machines_command():
        """Retrieves a collection of Machines related to a given file hash.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'ComputerDNSName', 'OSPlatform', 'LastIPAddress', 'LastExternalIPAddress', 'HealthStatus',
                   'RiskScore', 'ExposureLevel']
        file = demisto.args()['file_hash']
        machines_response = get_file_related_machines_request(file)
        machines_list = get_machines_list(machines_response)

        context_output = {
            'File': file,
            'Machines': machines_list
        }
        entry_context = {
            'MicrosoftATP.FileMachine(val.ID === obj.ID)': context_output
        }
        human_readable = tableToMarkdown(f'Microsoft Defender ATP machines related to file {file}', machines_list,
                                         headers=headers, removeNull=True)
        return human_readable, entry_context, machines_response


    def get_machine_details_command():
        """Retrieves specific Machine by its machine ID or computer name.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'ComputerDNSName', 'OSPlatform', 'LastIPAddress', 'LastExternalIPAddress', 'HealthStatus',
                   'RiskScore', 'ExposureLevel']
        machine_id = demisto.args()['machine_id']
        machine_response = get_machine_details_request(machine_id)
        machine_data = get_machine_data(machine_response)

        entry_context = {
            'MicrosoftATP.Machine(val.ID === obj.ID)': machine_data
        }
        human_readable = tableToMarkdown(f'Microsoft Defender ATP machine {machine_id} details:', machine_data,
                                         headers=headers, removeNull=True)
        return human_readable, entry_context, machine_response


    def run_antivirus_scan_command():
        """Initiate Windows Defender Antivirus scan on a machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        machine_id = demisto.args().get('machine_id')
        scan_type = demisto.args().get('scan_type')
        comment = demisto.args().get('comment')

        machine_action_response = run_antivirus_scan_request(machine_id, comment, scan_type)
        machine_action_data = get_machine_action_data(machine_action_response)

        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': machine_action_data
        }
        human_readable = tableToMarkdown('Antivirus scan successfully triggered', machine_action_data, headers=headers,
                                         removeNull=True)
        return human_readable, entry_context, machine_action_response


    def list_alerts_command():
        """Initiate Windows Defender Antivirus scan on a machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Title', 'Description', 'IncidentID', 'Severity', 'Status', 'Classification', 'Category',
                   'ThreatFamilyName', 'MachineID']
        severity = demisto.args().get('severity')
        status = demisto.args().get('status')
        fields_to_filter_by = {
            'severity': severity,
            'status': status
        }
        filter_req = reformat_filter(fields_to_filter_by)
        alerts_response = list_alerts_request(filter_req)
        alerts_list = get_alerts_list(alerts_response)

        entry_context = {
            'MicrosoftATP.Alert(val.ID === obj.ID)': alerts_list
        }
        human_readable = tableToMarkdown('Microsoft Defender ATP alerts:', alerts_list, headers=headers, removeNull=True)
        return human_readable, entry_context, alerts_response


    def get_alerts_list(alerts_response):
        """Get a raw response of alerts list

        Args:
            alerts_response (dict): The raw response with the alerts list in it

        Returns:
            list. Alerts list
        """
        alerts_list = []
        for alert in alerts_response['value']:
            alert_data = get_alert_data(alert)
            alerts_list.append(alert_data)
        return alerts_list


    def update_alert_command():
        """Updates properties of existing Alert.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        alert_id = demisto.args()['alert_id']
        assigned_to = demisto.args().get('assigned_to')
        status = demisto.args().get('status')
        classification = demisto.args().get('classification')
        determination = demisto.args().get('determination')
        comment = demisto.args().get('comment')

        args_list = [assigned_to, status, classification, determination, comment]
        check_given_args_update_alert(args_list)
        json, context = add_args_to_json_and_context(alert_id, assigned_to, status, classification, determination, comment)
        alert_response = update_alert_request(alert_id, json)
        entry_context = {
            'MicrosoftATP.Alert(val.ID === obj.ID)': context
        }
        human_readable = f'The alert {alert_id} has been updated successfully'
        return human_readable, entry_context, alert_response


    def check_given_args_update_alert(args_list):
        """Gets an arguments list and returns an error if all of them are empty
        """
        if all(v is None for v in args_list):
            return_error('No arguments were given to update the alert')


    def add_args_to_json_and_context(alert_id, assigned_to, status, classification, determination, comment):
        """Gets arguments and returns the json and context with the arguments inside
        """
        json = {}
        context = {
            'ID': alert_id
        }
        if assigned_to:
            json['assignedTo'] = assigned_to
            context['AssignedTo'] = assigned_to
        if status:
            json['status'] = status
            context['Status'] = status
        if classification:
            json['classification'] = classification
            context['Classification'] = classification
        if determination:
            json['determination'] = determination
            context['Determination'] = determination
        if comment:
            json['comment'] = comment
            context['Comment'] = comment
        return json, context


    def get_advanced_hunting_command():
        """Get results of advanced hunting according to user query.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        query = demisto.args().get('query')
        response = get_advanced_hunting_request(query)
        results = response.get('Results')
        if isinstance(results, list) and len(results) == 1:
            report_id = results[0].get('ReportId')
            if report_id:
                results[0]['ReportId'] = str(report_id)
        entry_context = {
            'MicrosoftATP.Hunt.Result': results
        }
        human_readable = tableToMarkdown('Hunt results', results, removeNull=True)

        return human_readable, entry_context, response


    def create_alert_command():
        """Creates new Alert on top of Event.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Title', 'Description', 'IncidentID', 'Severity', 'Status', 'Classification', 'Category',
                   'ThreatFamilyName', 'MachineID']
        args = demisto.args()
        alert_response = create_alert(
            args.get('machine_id'),
            args.get('severity'),
            args.get('title'),
            args.get('description'),
            args.get('event_time'),
            args.get('report_id'),
            args.get('recommended_action'),
            args.get('category')
        )
        alert_data = get_alert_data(alert_response)

        entry_context = {
            'MicrosoftATP.Alert(val.ID === obj.ID)': alert_data
        }
        human_readable = tableToMarkdown('Alert created:', alert_data, headers=headers, removeNull=True)
        return human_readable, entry_context, alert_response


    def get_alert_related_files_command():
        """Retrieves all files related to a specific alert.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['Sha1', 'Sha256', 'SizeInBytes', 'FileType', 'FilePublisher', 'FileProductName']
        alert_id = demisto.args().get('id')
        limit = demisto.args().get('limit')
        offset = demisto.args().get('offset')
        limit, offset = check_limit_and_offset_values(limit, offset)

        response = get_alert_related_files_request(alert_id)
        response_files_list = response['value']

        files_data_list = []
        from_index = min(offset, len(response_files_list))
        to_index = min(offset + limit, len(response_files_list))
        for file_obj in response_files_list[from_index:to_index]:
            files_data_list.append(get_file_data(file_obj))

        context_output = {
            'AlertID': alert_id,
            'Files': files_data_list
        }
        entry_context = {
            'MicrosoftATP.AlertFile(val.AlertID === obj.AlertID)': context_output
        }
        human_readable = tableToMarkdown(f'Alert {alert_id} Related Files:', files_data_list, headers=headers,
                                         removeNull=True)
        return human_readable, entry_context, response_files_list


    def check_limit_and_offset_values(limit, offset):
        """Gets the limit and offset values and return an error if the values are invalid
        """
        if not limit.isdigit():
            return_error("Error: You can only enter a positive integer or zero to limit argument.")
        elif not offset.isdigit():
            return_error("Error: You can only enter a positive integer to offset argument.")
        else:
            limit_int = int(limit)
            offset_int = int(offset)

            if limit_int == 0:
                return_error("Error: The value of the limit argument must be a positive integer.")

            return limit_int, offset_int


    def get_file_data(file_response):
        """Get file raw response and returns the file's info for context and human readable.

        Returns:
            dict. File's info
        """
        file_data = assign_params(**{
            'Sha1': file_response.get('sha1'),
            'Sha256': file_response.get('sha256'),
            'Md5': file_response.get('md5'),
            'GlobalPrevalence': file_response.get('globalPrevalence'),
            'GlobalFirstObserved': file_response.get('globalFirstObserved'),
            'GlobalLastObserved': file_response.get('globalLastObserved'),
            'SizeInBytes': file_response.get('size'),
            'FileType': file_response.get('fileType'),
            'IsPeFile': file_response.get('isPeFile'),
            'FilePublisher': file_response.get('filePublisher'),
            'FileProductName': file_response.get('fileProductName'),
            'Signer': file_response.get('signer'),
            'Issuer': file_response.get('issuer'),
            'SignerHash': file_response.get('signerHash'),
            'IsValidCertificate': file_response.get('isValidCertificate'),
            'DeterminationType': file_response.get('determinationType'),
            'DeterminationValue': file_response.get('determinationValue')
        })
        return file_data


    def get_alert_related_ips_command():
        """Retrieves all IPs related to a specific alert.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        alert_id = demisto.args().get('id')
        limit = demisto.args().get('limit')
        offset = demisto.args().get('offset')
        limit, offset = check_limit_and_offset_values(limit, offset)

        response = get_alert_related_ips_request(alert_id)
        response_ips_list = response['value']

        ips_list = []
        from_index = min(offset, len(response_ips_list))
        to_index = min(offset + limit, len(response_ips_list))

        for ip in response_ips_list[from_index:to_index]:
            ips_list.append(ip['id'])

        context_output = {
            'AlertID': alert_id,
            'IPs': ips_list
        }
        entry_context = {
            'MicrosoftATP.AlertIP(val.AlertID === obj.AlertID)': context_output
        }
        human_readable = f'Alert {alert_id} Related IPs: {ips_list}'
        return human_readable, entry_context, response_ips_list


    def get_alert_related_domains_command():
        """Retrieves all domains related to a specific alert.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        alert_id = demisto.args().get('id')
        limit = demisto.args().get('limit')
        offset = demisto.args().get('offset')
        limit, offset = check_limit_and_offset_values(limit, offset)
        response = get_alert_related_domains_request(alert_id)
        response_domains_list = response['value']
        domains_list = []
        from_index = min(offset, len(response_domains_list))
        to_index = min(offset + limit, len(response_domains_list))
        for domain in response_domains_list[from_index:to_index]:
            domains_list.append(domain['host'])
        context_output = {
            'AlertID': alert_id,
            'Domains': domains_list
        }
        entry_context = {
            'MicrosoftATP.AlertDomain(val.AlertID === obj.AlertID)': context_output
        }
        human_readable = f'Alert {alert_id} Related Domains: {domains_list}'
        return human_readable, entry_context, response_domains_list


    def get_machine_action_by_id_command():
        """Returns machine's actions, if machine ID is None, return all actions.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        action_id = demisto.args().get('id', '')
        status = demisto.args().get('status', '')
        machine_id = demisto.args().get('machine_id', '')
        type = demisto.args().get('type', '')
        requestor = demisto.args().get('requestor', '')
        if action_id:
            for index in range(3):
                try:
                    response = get_machine_action_by_id_request(action_id)
                    if response:
                        break
                except Exception as e:
                    if 'ResourceNotFound' in str(e) and index < 3:
                        time.sleep(1)
                    else:
                        return_error(f'Machine action {action_id} was not found')
            response = get_machine_action_by_id_request(action_id)
            action_data = get_machine_action_data(response)
            human_readable = tableToMarkdown(f'Action {action_id} Info:', action_data, headers=headers, removeNull=True)
            context_output = action_data
        else:
            # A dictionary that contains all of the fields the user want to filter results by.
            # It will be sent in the request so the requested filters are applied on the results
            fields_to_filter_by = {
                'status': status,
                'machineId': machine_id,
                'type': type,
                'requestor': requestor
            }
            filter_req = reformat_filter(fields_to_filter_by)
            response = get_machine_actions_request(filter_req)
            machine_actions_list = []
            for machine_action in response['value']:
                machine_actions_list.append(get_machine_action_data(machine_action))
            human_readable = tableToMarkdown('Machine actions Info:', machine_actions_list, headers=headers,
                                             removeNull=True)
            context_output = machine_actions_list
        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': context_output
        }
        return human_readable, entry_context, response


    def get_machine_action_data(machine_action_response):
        """Get machine raw response and returns the machine action info in context and human readable format.

        Notes:
             Machine action is a collection of actions you can apply on the machine, for more info
             https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/machineaction

        Returns:
            dict. Machine action's info
        """
        action_data = \
            {
                "ID": machine_action_response.get('id'),
                "Type": machine_action_response.get('type'),
                "Scope": machine_action_response.get('scope'),
                "Requestor": machine_action_response.get('requestor'),
                "RequestorComment": machine_action_response.get('requestorComment'),
                "Status": machine_action_response.get('status'),
                "MachineID": machine_action_response.get('machineId'),
                "ComputerDNSName": machine_action_response.get('computerDnsName'),
                "CreationDateTimeUtc": machine_action_response.get('creationDateTimeUtc'),
                "LastUpdateTimeUtc": machine_action_response.get('lastUpdateTimeUtc'),
                "RelatedFileInfo": {
                    "FileIdentifier": machine_action_response.get('fileIdentifier'),
                    "FileIdentifierType": machine_action_response.get('fileIdentifierType')

                }
            }
        return action_data


    def get_machine_investigation_package_command():
        """Collect investigation package from a machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        machine_id = demisto.args().get('machine_id')
        comment = demisto.args().get('comment')
        machine_action_response = get_investigation_package_request(machine_id, comment)
        action_data = get_machine_action_data(machine_action_response)
        human_readable = tableToMarkdown(f'Initiating collect investigation package from {machine_id} machine :',
                                         action_data, headers=headers, removeNull=True)
        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': action_data
        }
        return human_readable, entry_context, machine_action_response


    def get_investigation_package_sas_uri_command():
        """Returns a URI that allows downloading an Investigation package.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        action_id = demisto.args().get('action_id')
        response = get_investigation_package_sas_uri_request(action_id)
        link = {'Link': response['value']}
        human_readable = f'Success. This link is valid for a very short time and should be used immediately for' \
                         f' downloading the package to a local storage{link["Link"]}'
        entry_context = {
            'MicrosoftATP.InvestigationURI(val.Link === obj.Link)': link
        }
        return human_readable, entry_context, response


    def restrict_app_execution_command():
        """Restrict execution of all applications on the machine except a predefined set.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        machine_id = demisto.args().get('machine_id')
        comment = demisto.args().get('comment')
        machine_action_response = restrict_app_execution_request(machine_id, comment)

        action_data = get_machine_action_data(machine_action_response)
        human_readable = tableToMarkdown(f'Initiating Restrict execution of all applications on the machine {machine_id} '
                                         f'except a predefined set:', action_data, headers=headers, removeNull=True)
        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': action_data
        }
        return human_readable, entry_context, machine_action_response


    def remove_app_restriction_command():
        """Enable execution of any application on the machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        machine_id = demisto.args().get('machine_id')
        comment = demisto.args().get('comment')
        machine_action_response = remove_app_restriction_request(machine_id, comment)

        action_data = get_machine_action_data(machine_action_response)
        human_readable = tableToMarkdown(f'Removing applications restriction on the machine {machine_id}:', action_data,
                                         headers=headers, removeNull=True)
        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': action_data
        }
        return human_readable, entry_context, machine_action_response


    def stop_and_quarantine_file_command():
        """Stop execution of a file on a machine and delete it.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Type', 'Requestor', 'RequestorComment', 'Status', 'MachineID', 'ComputerDNSName']
        machine_id = demisto.args().get('machine_id')
        file_sha1 = demisto.args().get('file_hash')
        comment = demisto.args().get('comment')
        machine_action_response = stop_and_quarantine_file_request(machine_id, file_sha1, comment)
        action_data = get_machine_action_data(machine_action_response)
        human_readable = tableToMarkdown(f'Stopping the execution of a file on {machine_id} machine and deleting it:',
                                         action_data, headers=headers, removeNull=True)
        entry_context = {
            'MicrosoftATP.MachineAction(val.ID === obj.ID)': action_data
        }
        return human_readable, entry_context, machine_action_response


    def get_investigations_by_id_command():
        """Returns the investigation info, if investigation ID is None, return all investigations.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'StartTime', 'EndTime', 'CancelledBy', 'InvestigationState', 'StatusDetails', 'MachineID',
                   'ComputerDNSName', 'TriggeringAlertID']
        investigation_id = demisto.args().get('id', '')
        limit = demisto.args().get('limit')
        offset = demisto.args().get('offset')
        limit, offset = check_limit_and_offset_values(limit, offset)

        if investigation_id:
            response = get_investigation_by_id_request(investigation_id)
            investigation_data = get_investigation_data(response)
            human_readable = tableToMarkdown(f'Investigation {investigation_id} Info:', investigation_data, headers=headers,
                                             removeNull=True)
            context_output = investigation_data
        else:
            response = get_investigation_list_request()['value']
            investigations_list = []
            from_index = min(offset, len(response))
            to_index = min(offset + limit, len(response))
            for investigation in response[from_index:to_index]:
                investigations_list.append(get_investigation_data(investigation))
            human_readable = tableToMarkdown('Investigations Info:', investigations_list, headers=headers, removeNull=True)
            context_output = investigations_list
        entry_context = {
            'MicrosoftATP.Investigation(val.ID === obj.ID)': context_output
        }
        return human_readable, entry_context, response


    def get_investigation_data(investigation_response):
        """Get investigation raw response and returns the investigation info for context and human readable.

        Args:
            investigation_response: The investigation raw response
        Returns:
            dict. Investigation's info
        """
        investigation_data = {
            "ID": investigation_response.get('id'),
            "StartTime": investigation_response.get('startTime'),
            "EndTime": investigation_response.get('endTime'),
            "InvestigationState": investigation_response.get('state'),
            "CancelledBy": investigation_response.get('cancelledBy'),
            "StatusDetails": investigation_response.get('statusDetails'),
            "MachineID": investigation_response.get('machineId'),
            "ComputerDNSName": investigation_response.get('computerDnsName'),
            "TriggeringAlertID": investigation_response.get('triggeringAlertId')
        }
        return investigation_data


    def start_investigation_command():
        """Start automated investigation on a machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'StartTime', 'EndTime', 'CancelledBy', 'InvestigationState', 'StatusDetails', 'MachineID',
                   'ComputerDNSName', 'TriggeringAlertID']
        machine_id = demisto.args().get('machine_id')
        comment = demisto.args().get('comment')
        response = start_investigation_request(machine_id, comment)
        investigation_id = response['id']
        investigation_data = get_investigation_data(response)
        human_readable = tableToMarkdown(f'Starting investigation {investigation_id} on {machine_id} machine:',
                                         investigation_data, headers=headers, removeNull=True)
        entry_context = {
            'MicrosoftATP.Investigation(val.ID === obj.ID)': investigation_data
        }
        return human_readable, entry_context, response


    def get_domain_statistics_command():
        """Retrieves the statistics on the given domain.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        domain = demisto.args().get('domain')
        response = get_domain_statistics_request(domain)
        domain_statistics = get_domain_statistics(response)
        human_readable = tableToMarkdown(f'Statistics on {domain} domain:', domain_statistics, removeNull=True)

        context_output = {
            'Domain': domain,
            'Statistics': domain_statistics
        }
        entry_context = {
            'MicrosoftATP.DomainStatistics(val.Domain === obj.Domain)': context_output
        }
        return human_readable, entry_context, response


    def get_domain_statistics(domain_stat_response):
        """Gets the domain statistics response and returns it in context format.

        Returns:
            (dict). domain statistics context
        """
        domain_statistics = assign_params(**{
            "Host": domain_stat_response.get('host'),
            "OrgPrevalence": domain_stat_response.get('orgPrevalence'),
            "OrgFirstSeen": domain_stat_response.get('orgFirstSeen'),
            "OrgLastSeen": domain_stat_response.get('orgLastSeen')
        })
        return domain_statistics


    def get_domain_alerts_command():
        """Retrieves a collection of Alerts related to a given domain address.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Title', 'Description', 'IncidentID', 'Severity', 'Status', 'Classification', 'Category',
                   'ThreatFamilyName', 'MachineID']
        domain = demisto.args().get('domain')
        response = get_domain_alerts_request(domain)
        alerts_list = get_alerts_list(response)
        human_readable = tableToMarkdown(f'Domain {domain} related alerts Info:', alerts_list, headers=headers,
                                         removeNull=True)
        context_output = {
            'Domain': domain,
            'Alerts': alerts_list
        }
        entry_context = {
            'MicrosoftATP.DomainAlert(val.Domain === obj.Domain)': context_output
        }
        return human_readable, entry_context, response


    def get_alert_data(alert_response):
        """Get alert raw response and returns the alert info in context and human readable format.

        Returns:
            dict. Alert info
        """
        alert_data = {
            "ID": alert_response.get('id'),
            "IncidentID": alert_response.get('incidentId'),
            "InvestigationID": alert_response.get('investigationId'),
            "InvestigationState": alert_response.get('investigationState'),
            "AssignedTo": alert_response.get('assignedTo'),
            "Severity": alert_response.get('severity'),
            "Status": alert_response.get('status'),
            "Classification": alert_response.get('classification'),
            "Determination": alert_response.get('determination'),
            "DetectionSource": alert_response.get('detectionSource'),
            "Category": alert_response.get('category'),
            "ThreatFamilyName": alert_response.get('threatFamilyName'),
            "Title": alert_response.get('title'),
            "Description": alert_response.get('description'),
            "AlertCreationTime": alert_response.get('alertCreationTime'),
            "FirstEventTime": alert_response.get('firstEventTime'),
            "LastEventTime": alert_response.get('lastEventTime'),
            "LastUpdateTime": alert_response.get('lastUpdateTime'),
            "ResolvedTime": alert_response.get('resolvedTime'),
            "MachineID": alert_response.get('machineId'),
            "ComputerDNSName": alert_response.get('computerDnsName'),
            "AADTenantID": alert_response.get('aadTenantId'),
            "Comments": [
                {
                    "Comment": alert_response.get('comment'),
                    "CreatedBy": alert_response.get('createdBy'),
                    "CreatedTime": alert_response.get('createdTime')
                }
            ],
            "Evidence": alert_response.get('evidence')
        }

        return alert_data


    def get_domain_machine_command():
        """Retrieves a collection of Machines that have communicated to or from a given domain address.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """

        headers = ['ID', 'ComputerDNSName', 'OSPlatform', 'LastIPAddress', 'LastExternalIPAddress', 'HealthStatus',
                   'RiskScore', 'ExposureLevel']
        domain = demisto.args().get('domain')
        response = get_domain_machines_request(domain)
        machines_list = get_machines_list(response)
        human_readable = tableToMarkdown(f'Machines that have communicated with {domain} domain:', machines_list,
                                         headers=headers, removeNull=True)
        context_output = {
            'Domain': domain,
            'Machines': machines_list
        }
        entry_context = {
            'MicrosoftATP.DomainMachine(val.Domain === obj.Domain)': context_output
        }
        return human_readable, entry_context, response


    def get_machine_data(machine):
        """Get machine raw response and returns the machine's info in context and human readable format.

        Returns:
            dict. Machine's info
        """
        machine_data = assign_params(**{
            'ID': machine.get('id'),
            'ComputerDNSName': machine.get('computerDnsName'),
            'FirstSeen': machine.get('firstSeen'),
            'LastSeen': machine.get('lastSeen'),
            'OSPlatform': machine.get('osPlatform'),
            'OSVersion': machine.get('version'),
            'OSProcessor': machine.get('osProcessor'),
            'LastIPAddress': machine.get('lastIpAddress'),
            'LastExternalIPAddress': machine.get('lastExternalIpAddress'),
            'AgentVersion': machine.get('agentVersion'),
            'OSBuild': machine.get('osBuild'),
            'HealthStatus': machine.get('healthStatus'),
            'RBACGroupID': machine.get('rbacGroupId'),
            'RBACGroupName': machine.get('rbacGroupName'),
            'RiskScore': machine.get('riskScore'),
            'ExposureLevel': machine.get('exposureLevel'),
            'AADDeviceID': machine.get('aadDeviceId'),
            'IsAADJoined': machine.get('isAadJoined'),
            'MachineTags': machine.get('machineTags'),
        })
        return machine_data


    def get_file_statistics_command():
        """Retrieves the statistics on the given file.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        file_sha1 = demisto.args().get('file_hash')
        response = get_file_statistics_request(file_sha1)
        file_stat = get_file_statistics(response)
        human_readable = tableToMarkdown(f'Statistics on {file_sha1} file:', file_stat, removeNull=True)
        context_output = {
            'Sha1': file_sha1,
            'Statistics': file_stat
        }
        entry_context = {
            'MicrosoftATP.FileStatistics(val.Sha1 === obj.Sha1)': context_output
        }
        return human_readable, entry_context, response


    def get_file_statistics(file_stat_response):
        """Gets the file statistics response and returns it in context format.

        Returns:
            (dict). File statistics context
        """
        file_stat = assign_params(**{
            "OrgPrevalence": file_stat_response.get('orgPrevalence'),
            "OrgFirstSeen": file_stat_response.get('orgFirstSeen'),
            "OrgLastSeen": file_stat_response.get('orgLastSeen'),
            "GlobalPrevalence": file_stat_response.get('globalPrevalence'),
            "GlobalFirstObserved": file_stat_response.get('globalFirstObserved'),
            "GlobalLastObserved": file_stat_response.get('globalLastObserved'),
            "TopFileNames": file_stat_response.get('topFileNames')
        })
        return file_stat


    def get_file_alerts_command():
        """Retrieves a collection of Alerts related to a given file hash.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Title', 'Description', 'IncidentID', 'Severity', 'Status', 'Classification', 'Category',
                   'ThreatFamilyName', 'MachineID']
        file_sha1 = demisto.args().get('file_hash')
        response = get_file_alerts_request(file_sha1)
        alerts_list = get_alerts_list(response)
        hr = tableToMarkdown(f'File {file_sha1} related alerts Info:', alerts_list, headers=headers, removeNull=True)
        context_output = {
            'Sha1': file_sha1,
            'Alerts': alerts_list
        }
        ec = {
            'MicrosoftATP.FileAlert(val.Sha1 === obj.Sha1)': context_output
        }
        return hr, ec, response


    def get_ip_statistics_command():
        """Retrieves the statistics on the given IP.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        ip = demisto.args().get('ip')
        response = get_ip_statistics_request(ip)
        ip_statistics = get_ip_statistics(response)
        hr = tableToMarkdown(f'Statistics on {ip} IP:', ip_statistics, removeNull=True)
        context_output = {
            'IPAddress': ip,
            'Statistics': ip_statistics
        }
        ec = {
            'MicrosoftATP.IPStatistics(val.IPAddress === obj.IPAddress)': context_output
        }
        return hr, ec, response


    def get_ip_statistics(ip_statistics_response):
        """Gets the IP statistics response and returns it in context format.

        Returns:
            (dict). IP statistics context
        """
        ip_statistics = assign_params(**{
            "OrgPrevalence": ip_statistics_response.get('orgPrevalence'),
            "OrgFirstSeen": ip_statistics_response.get('orgFirstSeen'),
            "OrgLastSeen": ip_statistics_response.get('orgLastSeen')
        })
        return ip_statistics


    def get_ip_alerts_command():
        """Retrieves a collection of Alerts related to a given IP.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Title', 'Description', 'IncidentID', 'Severity', 'Status', 'Classification', 'Category',
                   'ThreatFamilyName', 'MachineID']
        ip = demisto.args().get('ip')
        response = get_ip_alerts_request(ip)
        alerts_list = get_alerts_list(response)
        human_readable = tableToMarkdown(f'IP {ip} related alerts Info:', alerts_list, headers=headers, removeNull=True)
        context_output = {
            'IPAddress': ip,
            'Alerts': alerts_list
        }
        entry_context = {
            'MicrosoftATP.IPAlert(val.IPAddress === obj.IPAddress)': context_output
        }
        return human_readable, entry_context, response


    def get_user_alerts_command():
        """Retrieves a collection of Alerts related to a given user ID.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'Title', 'Description', 'IncidentID', 'Severity', 'Status', 'Classification', 'Category',
                   'ThreatFamilyName', 'MachineID']
        username = demisto.args().get('username')
        response = get_user_alerts_request(username)
        alerts_list = get_alerts_list(response)
        human_readable = tableToMarkdown(f'User {username} related alerts Info:', alerts_list, headers=headers, removeNull=True)
        context_output = {
            'Username': username,
            'Alerts': alerts_list
        }
        entry_context = {
            'MicrosoftATP.UserAlert(val.Username === obj.Username)': context_output
        }
        return human_readable, entry_context, response


    def get_user_machine_command():
        """Retrieves a collection of machines related to a given user ID.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'ComputerDNSName', 'OSPlatform', 'LastIPAddress', 'LastExternalIPAddress', 'HealthStatus',
                   'RiskScore', 'ExposureLevel']
        username = demisto.args().get('username')
        response = get_user_machines_request(username)
        machines_list = get_machines_list(response)
        human_readable = tableToMarkdown(f'Machines that are related to user {username}:', machines_list, headers=headers,
                                         removeNull=True)
        context_output = {
            'Username': username,
            'Machines': machines_list
        }
        entry_context = {
            'MicrosoftATP.UserMachine(val.Username === obj.Username)': context_output
        }
        return human_readable, entry_context, response


    def add_remove_machine_tag_command():
        """Adds or remove tag to a specific Machine.

        Returns:
            (str, dict, dict). Human readable, context, raw response
        """
        headers = ['ID', 'ComputerDNSName', 'OSPlatform', 'LastIpAddress', 'LastExternalIPAddress', 'HealthStatus',
                   'RiskScore', 'ExposureLevel', 'MachineTags']
        machine_id = demisto.args().get('machine_id')
        action = demisto.args().get('action')
        tag = demisto.args().get('tag')
        response = add_remove_machine_tag_request(machine_id, action, tag)
        machine_data = get_machine_data(response)
        human_readable = tableToMarkdown(f'Succeed to {action} tag to {machine_id}:', machine_data, headers=headers,
                                         removeNull=True)
        entry_context = {
            'MicrosoftATP.Machine(val.ID === obj.ID)': machine_data
        }
        return human_readable, entry_context, response


    def fetch_incidents():
        last_run = demisto.getLastRun()
        last_alert_fetched_time = get_last_alert_fetched_time(last_run)
        existing_ids = last_run.get('existing_ids', [])
        latest_creation_time = last_alert_fetched_time
        filter_alerts_creation_time = create_filter_alerts_creation_time(last_alert_fetched_time)
        alerts = list_alerts_request(filter_alerts_creation_time)['value']

        incidents, new_ids, latest_creation_time = all_alerts_to_incidents(alerts, latest_creation_time, existing_ids)

        demisto.setLastRun({
            'last_alert_fetched_time': datetime.strftime(latest_creation_time, '%Y-%m-%dT%H:%M:%S'),
            'existing_ids': new_ids
        })
        demisto.incidents(incidents)


    def create_filter_alerts_creation_time(last_alert_fetched_time):
        """Create filter with the last alert fetched time to send in the request.

        Args:
            last_alert_fetched_time(date): Last date and time of alert that been fetched

        Returns:
            (str). The filter of alerts creation time that will be send in the  alerts list API request
        """
        filter_alerts_creation_time = f"alertCreationTime+gt+{last_alert_fetched_time.isoformat()}"

        if not filter_alerts_creation_time.endswith('Z'):
            filter_alerts_creation_time = filter_alerts_creation_time + "Z"

        return filter_alerts_creation_time


    def all_alerts_to_incidents(alerts, latest_creation_time, existing_ids):
        """Gets the alerts list and convert it to incidents.

        Args:
            alerts(list): List of alerts filtered by the first_fetch_timestamp parameter
            latest_creation_time(date):  Last date and time of alert that been fetched
            existing_ids(list): List of alerts IDs that already been fetched

        Returns:(list, list, date). Incidents list, new alerts IDs list, latest alert creation time
        """
        incidents = []
        new_ids = []
        for alert in alerts:
            alert_creation_time_for_incident = parse(alert['alertCreationTime'])
            reformatted_alert_creation_time_for_incident = \
                aware_timestamp_to_naive_timestamp(alert_creation_time_for_incident)

            if should_fetch_alert(alert, existing_ids):
                incident = alert_to_incident(alert, reformatted_alert_creation_time_for_incident)
                incidents.append(incident)

                if reformatted_alert_creation_time_for_incident == latest_creation_time:
                    new_ids.append(alert["id"])
                if reformatted_alert_creation_time_for_incident > latest_creation_time:
                    latest_creation_time = reformatted_alert_creation_time_for_incident
                    new_ids = [alert['id']]

        if not new_ids:
            new_ids = existing_ids
        return incidents, new_ids, latest_creation_time


    def aware_timestamp_to_naive_timestamp(aware_timestamp):
        """Gets aware timestamp and reformatting it to naive timestamp

        Args:
            aware_timestamp(date): The alert creation time after parse to aware timestamp

        Returns:(date). Naive timestamp for alert creation time
        """
        iso_aware = aware_timestamp.isoformat()
        # Deal with timestamp like: 2020-03-26T17:24:58.441093
        if '.' in iso_aware:
            iso_aware = iso_aware.split('.')[0]
        # Deal with timestamp like: 2020-03-14T22:11:20+0000
        elif '+' in iso_aware:
            iso_aware = iso_aware.split('+')[0]
        return datetime.strptime(iso_aware, '%Y-%m-%dT%H:%M:%S')


    def should_fetch_alert(alert, existing_ids):
        """ Check the alert to see if it's data stands by the conditions.

        Args:
            alert (dict): The alert data
            existing_ids (list): The existing alert's ids list

        Returns:
            True - if the alert is according to the conditions, else False
        """
        alert_status = alert['status']
        alert_severity = alert['severity']
        if alert_status in ALERT_STATUS_TO_FETCH and alert_severity in ALERT_SEVERITIES_TO_FETCH and alert['id']\
                not in existing_ids:
            return True
        return False


    def get_last_alert_fetched_time(last_run):
        """Gets fetch last run and returns the last alert fetch time.

        Returns:
            (date). The date and time of the last alert that been fetched
        """
        if last_run and last_run['last_alert_fetched_time']:
            last_alert_fetched_time = datetime.strptime(last_run['last_alert_fetched_time'], '%Y-%m-%dT%H:%M:%S')
        else:
            last_alert_fetched_time, _ = parse_date_range(date_range=ALERT_TIME_TO_FETCH, date_format='%Y-%m-%dT%H:%M:%S',
                                                          utc=False, to_timestamp=False)
            last_alert_fetched_time = datetime.strptime(str(last_alert_fetched_time), '%Y-%m-%dT%H:%M:%S')

        return last_alert_fetched_time


    def test_module():
        token = get_access_token()
        response = requests.get(
            BASE_URL + '/alerts',
            headers={
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            params={'$top': '1'},
            verify=USE_SSL
        )
        try:
            _ = response.json() if response.text else {}
            if not response.ok:
                return_error(f'API call to Windows Advanced Threat Protection. '
                             f'Please check authentication related parameters. '
                             f'[{response.status_code}] - {response.reason}')

            demisto.results('ok')

        except TypeError as ex:
            demisto.debug(str(ex))
            return_error(f'API call to Windows Advanced Threat Protection failed, could not parse result. '
                         f'Please check authentication related parameters. [{response.status_code}]')


    ''' EXECUTION CODE '''

    LOG('command is %s' % (demisto.command(), ))

    try:
        if demisto.command() == 'test-module':
            test_module()

        elif demisto.command() == 'fetch-incidents':
            fetch_incidents()

        elif demisto.command() == 'microsoft-atp-isolate-machine':
            return_outputs(*isolate_machine_command())

        elif demisto.command() == 'microsoft-atp-unisolate-machine':
            return_outputs(*unisolate_machine_command())

        elif demisto.command() == 'microsoft-atp-get-machines':
            return_outputs(*get_machines_command())

        elif demisto.command() == 'microsoft-atp-get-file-related-machines':
            return_outputs(*get_file_related_machines_command())

        elif demisto.command() == 'microsoft-atp-get-machine-details':
            return_outputs(*get_machine_details_command())

        elif demisto.command() == 'microsoft-atp-run-antivirus-scan':
            return_outputs(*run_antivirus_scan_command())

        elif demisto.command() == 'microsoft-atp-list-alerts':
            return_outputs(*list_alerts_command())

        elif demisto.command() == 'microsoft-atp-update-alert':
            return_outputs(*update_alert_command())

        elif demisto.command() == 'microsoft-atp-advanced-hunting':
            return_outputs(*get_advanced_hunting_command())

        elif demisto.command() == 'microsoft-atp-create-alert':
            return_outputs(*create_alert_command())

        elif demisto.command() == 'microsoft-atp-get-alert-related-user':
            return_outputs(*get_alert_related_user_command())

        elif demisto.command() == 'microsoft-atp-get-alert-related-files':
            return_outputs(*get_alert_related_files_command())

        elif demisto.command() == 'microsoft-atp-get-alert-related-ips':
            return_outputs(*get_alert_related_ips_command())

        elif demisto.command() == 'microsoft-atp-get-alert-related-domains':
            return_outputs(*get_alert_related_domains_command())

        elif demisto.command() == 'microsoft-atp-list-machine-actions-details':
            return_outputs(*get_machine_action_by_id_command())

        elif demisto.command() == 'microsoft-atp-collect-investigation-package':
            return_outputs(*get_machine_investigation_package_command())

        elif demisto.command() == 'microsoft-atp-get-investigation-package-sas-uri':
            return_outputs(*get_investigation_package_sas_uri_command())

        elif demisto.command() == 'microsoft-atp-restrict-app-execution':
            return_outputs(*restrict_app_execution_command())

        elif demisto.command() == 'microsoft-atp-remove-app-restriction':
            return_outputs(*remove_app_restriction_command())

        elif demisto.command() == 'microsoft-atp-stop-and-quarantine-file':
            return_outputs(*stop_and_quarantine_file_command())

        elif demisto.command() == 'microsoft-atp-list-investigations':
            return_outputs(*get_investigations_by_id_command())

        elif demisto.command() == 'microsoft-atp-start-investigation':
            return_outputs(*start_investigation_command())

        elif demisto.command() == 'microsoft-atp-get-domain-statistics':
            return_outputs(*get_domain_statistics_command())

        elif demisto.command() == 'microsoft-atp-get-domain-alerts':
            return_outputs(*get_domain_alerts_command())

        elif demisto.command() == 'microsoft-atp-get-domain-machines':
            return_outputs(*get_domain_machine_command())

        elif demisto.command() == 'microsoft-atp-get-file-statistics':
            return_outputs(*get_file_statistics_command())

        elif demisto.command() == 'microsoft-atp-get-file-alerts':
            return_outputs(*get_file_alerts_command())

        elif demisto.command() == 'microsoft-atp-get-ip-statistics':
            return_outputs(*get_ip_statistics_command())

        elif demisto.command() == 'microsoft-atp-get-ip-alerts':
            return_outputs(*get_ip_alerts_command())

        elif demisto.command() == 'microsoft-atp-get-user-alerts':
            return_outputs(*get_user_alerts_command())

        elif demisto.command() == 'microsoft-atp-get-user-machines':
            return_outputs(*get_user_machine_command())

        elif demisto.command() == 'microsoft-atp-add-remove-machine-tag':
            return_outputs(*add_remove_machine_tag_command())
    except Exception as e:
        return_error(str(e))
  subtype: python3
  type: python
system: true
