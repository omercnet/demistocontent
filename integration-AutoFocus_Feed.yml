category: Data Enrichment & Threat Intelligence
commonfields:
  id: AutoFocus Feed
  version: -1
configuration:
- defaultvalue: ""
  display: Indicator feed
  name: indicator_feeds
  options:
  - Daily Threat Feed
  - Custom Feed
  required: true
  type: 16
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ""
  display: The AutoFocus API key
  name: api_key
  required: true
  type: 4
- additionalinfo: Only necessary in case a Custom Feed is fetched. Can also support
    a CSV of Custom feed URLs.
  defaultvalue: ""
  display: The URL for the custom feed to fetch
  name: custom_feed_urls
  required: false
  type: 0
- defaultvalue: ""
  display: Fetch indicators
  name: feed
  required: false
  type: 8
- defaultvalue: suddenDeath
  display: ""
  name: feedExpirationPolicy
  options:
  - never
  - interval
  - indicatorType
  - suddenDeath
  required: false
  type: 17
- defaultvalue: "20160"
  display: ""
  name: feedExpirationInterval
  required: false
  type: 1
- additionalinfo: Indicators from this integration instance will be marked with this
    reputation
  defaultvalue: feedInstanceReputationNotSet
  display: Indicator Reputation
  name: feedReputation
  options:
  - None
  - Good
  - Suspicious
  - Bad
  required: false
  type: 18
- additionalinfo: Reliability of the source providing the intelligence data
  defaultvalue: A - Completely reliable
  display: Source Reliability
  name: feedReliability
  options:
  - A - Completely reliable
  - B - Usually reliable
  - C - Fairly reliable
  - D - Not usually reliable
  - E - Unreliable
  - F - Reliability cannot be judged
  required: true
  type: 15
- defaultvalue: "15"
  display: Feed Fetch Interval
  name: feedFetchInterval
  required: false
  type: 19
- additionalinfo: When selected, the exclusion list is ignored for indicators from
    this feed. This means that if an indicator from this feed is on the exclusion
    list, the indicator might still be added to the system.
  defaultvalue: ""
  display: Bypass exclusion list
  name: feedBypassExclusionList
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    propagationLabels:
    - all
description: Use the AutoFocus Feeds integration to fetch indicators from AutoFocus.
detaileddescription: |
  ## AutoFocus Feed
  Gets Daily Threat Feed and Custom feeds from AutoFocus.

  For more information see the [AutoFocus documentation](https://docs.paloaltonetworks.com/autofocus/autofocus-admin/autofocus-feeds.html).

  #### Custom Feed info:
  To connect a custom AutoFocus feed you need to provide the Custom Feed URL.

  The Custom Feed URL should be in this form:
  https://autofocus.paloaltonetworks.com/IOCFeed/{Output_Feed_ID}/{Output_Feed_Name}
display: AutoFocus Feed
image: data:image/png;base64,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
name: AutoFocus Feed
script:
  commands:
  - arguments:
    - defaultValue: "10"
      description: The maximum number of indicators to return. The default value is
        10.
      name: limit
      required: true
    - defaultValue: "0"
      description: The index of the first indicator to fetch.
      name: offset
    description: Gets the indicators from AutoFocus.
    name: autofocus-get-indicators
  dockerimage: demisto/python3:3.8.1.5734
  feed: true
  runonce: false
  script: |2-




    # IMPORTS
    import re
    import requests
    from typing import List
    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    # CONSTANTS
    SOURCE_NAME = "AutoFocusFeed"


    class Client(BaseClient):
        """Client for AutoFocus Feed - gets indicator lists from the Custom and Daily threat feeds

        Attributes:
            api_key(str): The API key for AutoFocus.
            insecure(bool): Use SSH on http request.
            proxy(str): Use system proxy.
            indicator_feeds(List): A list of indicator feed types to bring from AutoFocus.
            custom_feed_urls(str): The URLs of the custom feeds to fetch.
        """

        def __init__(self, api_key, insecure, proxy, indicator_feeds, custom_feed_urls=None):
            self.daily_feed_base_url = "https://autofocus.paloaltonetworks.com/api/v1.0/output/threatFeedResult"
            self.headers = {
                "apiKey": api_key,
                'Content-Type': "application/json"
            }
            self.indicator_feeds = indicator_feeds
            if 'Custom Feed' in indicator_feeds and (custom_feed_urls is None or custom_feed_urls == ''):
                return_error("Output Feed ID and Name are required for Custom Feed")

            elif 'Custom Feed' in indicator_feeds:
                url_list = []  # type:List
                for url in custom_feed_urls.split(','):
                    url_list.append(self.url_format(url))

                self.custom_feed_url_list = url_list

            self.verify = not insecure
            if proxy:
                handle_proxy()

        def url_format(self, url):
            """Make sure the URL is in the format:
            https://autofocus.paloaltonetworks.com/api/v1.0/IOCFeed/{ID}/{Name}

            Args:
                url(str): The URL to format.

            Returns:
                str. The reformatted URL.
            """
            if "https://autofocus.paloaltonetworks.com/IOCFeed/" in url:
                url = url.replace("https://autofocus.paloaltonetworks.com/IOCFeed/",
                                  "https://autofocus.paloaltonetworks.com/api/v1.0/IOCFeed/")

            elif "autofocus.paloaltonetworks.com/IOCFeed/" in url:
                url = url.replace("autofocus.paloaltonetworks.com/IOCFeed/",
                                  "https://autofocus.paloaltonetworks.com/api/v1.0/IOCFeed/")

            return url

        def http_request(self, feed_type) -> list:
            """The HTTP request for the feed.

            Args:
                feed_type(str): The feed type (Daily or Custom feed).

            Returns:
                list. A list of indicators fetched from the feed.
            """
            if feed_type == "Daily Threat Feed":
                urls = [self.daily_feed_base_url]

            else:
                urls = self.custom_feed_url_list

            indicator_list = []  # type:List
            for url in urls:
                res = requests.request(
                    method="GET",
                    url=url,
                    verify=self.verify,
                    headers=self.headers
                )
                res.raise_for_status()
                indicator_list.extend(res.text.split('\n'))

            return indicator_list

        def get_ip_type(self, indicator):
            if re.match(ipv4cidrRegex, indicator):
                return FeedIndicatorType.CIDR

            elif re.match(ipv6cidrRegex, indicator):
                return FeedIndicatorType.IPv6CIDR

            elif re.match(ipv4Regex, indicator):
                return FeedIndicatorType.IP

            elif re.match(ipv6Regex, indicator):
                return FeedIndicatorType.IPv6

            else:
                return None

        def find_indicator_type(self, indicator):
            """Infer the type of the indicator.

            Args:
                indicator(str): The indicator whose type we want to check.

            Returns:
                str. The type of the indicator.
            """

            # trying to catch X.X.X.X:portNum
            if ':' in indicator and '/' not in indicator:
                sub_indicator = indicator.split(':', 1)[0]
                ip_type = self.get_ip_type(sub_indicator)
                if ip_type:
                    return ip_type

            ip_type = self.get_ip_type(indicator)
            if ip_type:
                # catch URLs of type X.X.X.X/path/url or X.X.X.X:portNum/path/url
                if '/' in indicator and (ip_type not in [FeedIndicatorType.IPv6CIDR, FeedIndicatorType.CIDR]):
                    return FeedIndicatorType.URL

                else:
                    return ip_type

            elif re.match(sha256Regex, indicator):
                return FeedIndicatorType.File

            # in AutoFocus, URLs include a path while domains do not - so '/' is a good sign for us to catch URLs.
            elif '/' in indicator:
                return FeedIndicatorType.URL

            else:
                return FeedIndicatorType.Domain

        def build_iterator(self, limit=None, offset=None):
            """Builds a list of indicators.

            Returns:
                list. A list of JSON objects representing indicators fetched from a feed.
            """
            indicators = []  # type:List

            if "Daily Threat Feed" in self.indicator_feeds:
                indicators.extend(self.http_request(feed_type="Daily Threat Feed"))

            if "Custom Feed" in self.indicator_feeds:
                indicators.extend(self.http_request(feed_type="Custom Feed"))

            if limit:
                indicators = indicators[int(offset): int(offset) + int(limit)]

            parsed_indicators = []  # type:List

            for indicator in indicators:
                if indicator:
                    indicator_type = self.find_indicator_type(indicator)

                    # catch ip of the form X.X.X.X:portNum and extract the IP without the port.
                    if indicator_type in [FeedIndicatorType.IP, FeedIndicatorType.CIDR,
                                          FeedIndicatorType.IPv6CIDR, FeedIndicatorType.IPv6] and ":" in indicator:
                        indicator = indicator.split(":", 1)[0]

                    parsed_indicators.append({
                        "type": indicator_type,
                        "value": indicator,
                        "rawJSON": {
                            'value': indicator,
                            'type': indicator_type
                        }
                    })

            return parsed_indicators


    def module_test_command(client: Client, args: dict):
        """
        Returning 'ok' indicates that the integration works like it is supposed to. Connection to the service is successful.

        Args:
            client: Autofocus Feed client

        Returns:
            'ok' if test passed, anything else will fail the test.
        """
        indicator_feeds = client.indicator_feeds
        exception_list = []  # type:List
        if 'Daily Threat Feed' in indicator_feeds:
            client.indicator_feeds = ['Daily Threat Feed']
            try:
                client.build_iterator(1, 0)
            except Exception:
                exception_list.append("Could not fetch Daily Threat Feed\n"
                                      "\nCheck your API key and your connection to AutoFocus.")

        if 'Custom Feed' in indicator_feeds:
            client.indicator_feeds = ['Custom Feed']
            url_list = client.custom_feed_url_list
            for url in url_list:
                client.custom_feed_url_list = [url]
                try:
                    client.build_iterator(1, 0)
                except Exception:
                    exception_list.append(f"Could not fetch Custom Feed {url}\n"
                                          f"\nCheck your API key the URL for the feed and Check "
                                          f"if they are Enabled in AutoFocus.")

        if len(exception_list) > 0:
            raise Exception("\n".join(exception_list))

        return 'ok', {}, {}


    def get_indicators_command(client: Client, args: dict):
        """Initiate a single fetch-indicators

        Args:
            client(Client): The AutoFocus Client.
            args(dict): Command arguments.

        Returns:
            str, dict, list. the markdown table, context JSON and list of indicators
        """
        offset = int(args.get('offset', 0))
        limit = int(args.get('limit', 100))

        indicators = fetch_indicators_command(client, limit, offset)

        hr_indicators = []
        for indicator in indicators:
            hr_indicators.append({
                "Value": indicator.get('value'),
                "Type": indicator.get('type')
            })

        human_readable = tableToMarkdown("Indicators from AutoFocus:", hr_indicators,
                                         headers=['Value', 'Type'], removeNull=True)

        if args.get('limit'):
            human_readable = human_readable + f"\nTo bring the next batch of indicators run:\n!autofocus-get-indicators " \
                f"limit={args.get('limit')} offset={int(str(args.get('limit'))) + int(str(args.get('offset')))}"

        return human_readable, {}, indicators


    def fetch_indicators_command(client: Client, limit=None, offset=None):
        """Fetch-indicators command from AutoFocus Feeds

        Args:
            client(Client): AutoFocus Feed client.
            limit: limit the amount of incidators fetched.
            offset: the index of the first index to fetch.

        Returns:
            list. List of indicators.
        """
        indicators = client.build_iterator(limit, offset)

        return indicators


    def main():
        params = demisto.params()

        client = Client(params.get('api_key'),
                        params.get('insecure'),
                        params.get('proxy'),
                        params.get('indicator_feeds'),
                        params.get('custom_feed_urls'))

        command = demisto.command()
        demisto.info(f'Command being called is {command}')
        # Switch case
        commands = {
            'test-module': module_test_command,
            'autofocus-get-indicators': get_indicators_command
        }
        try:
            if demisto.command() == 'fetch-indicators':
                indicators = fetch_indicators_command(client)
                # we submit the indicators in batches
                for b in batch(indicators, batch_size=2000):
                    demisto.createIndicators(b)
            else:
                readable_output, outputs, raw_response = commands[command](client, demisto.args())
                return_outputs(readable_output, outputs, raw_response)
        except Exception as e:
            raise Exception(f'Error in {SOURCE_NAME} Integration [{e}]')


    if __name__ == '__builtin__' or __name__ == 'builtins':
        main()
  subtype: python3
  type: python
system: true
