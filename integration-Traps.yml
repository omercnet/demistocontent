category: Endpoint
commonfields:
  id: Traps
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Application ID
  name: application_id
  required: true
  type: 0
- defaultvalue: ""
  display: Private Key
  name: private_key
  required: true
  type: 14
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    propagationLabels:
    - all
description: |-
  Endpoint protection and response stops threats on endpoints and coordinates enforcement with network and cloud security to prevent successful cyberattacks.
  The integration enables the following abilities:
    - Initiate scans.
    - Retrieve files from events.
    - Isolate endpoints.
    - Quarantine files.
    - Add and remove hashes from blacklist.
    - Getting endpoints info.
detaileddescription: " ## Traps TMS\n **Endpoint protection and response stops threats
  on endpoints and coordinates enforcement with network and cloud security to prevent
  successful cyberattacks.**\n \n ### Integrations credentials\n 1. To create your
  API key and client ID go to the Traps TMS UI. \n 2. Click the settings button and
  choose API Keys. \n 3. Click the **Add** button to create new API Key. \n 4. Beware
  to copy and save your API key as you will not be able to restore it. When coping
  the API Key note to include the whole text. \n 5. Paste the API Key and with Client
  ID back to the Traps integration configuration in Demisto. \n \n "
display: Palo Alto Networks Traps
image: data:image/png;base64,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
name: Traps
script:
  commands:
  - arguments:
    - description: Endpoint ID.
      isArray: true
      name: endpoint_id
      required: true
    description: Returns details for the specified endpoint.
    name: traps-get-endpoint-by-id
    outputs:
    - contextPath: Traps.Endpoint.ID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Name
      description: The name of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Domain
      description: The domain of the endpoint.
      type: date
    - contextPath: Traps.Endpoint.Platform
      description: The OS of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Status
      description: The status of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.IP
      description: The IP address of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.ComputerSid
      description: The computer SID.
      type: String
    - contextPath: Traps.Endpoint.IsCompromised
      description: Whether the endpoint is compromised.
      type: String
    - contextPath: Traps.Endpoint.OsVersion
      description: The version of the OS on the endpoint.
      type: String
    - contextPath: Traps.Endpoint.OsProductType
      description: The OS type of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.OsProductName
      description: The name of the OS on the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Is64
      description: The bitness of the OS on the endpoint.
      type: String
    - contextPath: Traps.Endpoint.LastSeen
      description: The date/time of the last active ping.
      type: String
    - contextPath: Traps.Endpoint.LastUser
      description: The last active user on the machine.
      type: String
    - contextPath: Traps.Endpoint.ScanStatus
      description: The status of the last scan run on the machine.
      type: String
  - arguments:
    - description: The ID of the endpoint.
      name: endpoint_id
      required: true
    - description: The name of the file to retrieve (including path).
      name: file_name
      required: true
    - description: The ID of the event.
      name: event_id
      required: true
    description: Executes a file retrieve operation / SAM on the specified agent.
    name: traps-endpoint-files-retrieve
    outputs:
    - contextPath: Traps.FileRetrieve.EndpointID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.FileRetrieve.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.FileRetrieve.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the endpoint.
      name: endpoint_id
      required: true
    description: Performs a scan operation on the specified endpoint.
    name: traps-endpoint-scan
    outputs:
    - contextPath: Traps.Scan.EndpointID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.Scan.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.Scan.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the event to modify.
      name: event_id
      required: true
    - auto: PREDEFINED
      description: The new status for the event.
      name: status
      predefined:
      - new
      - investigating
      - closed
    - description: A comment for the event.
      name: comment
    description: Modifies the status and adds a comment to an existing event.
    name: traps-event-update
  - arguments:
    - description: A comma-separated list of IDs for events to modify.
      isArray: true
      name: event_ids
      required: true
    - auto: PREDEFINED
      description: The new status for the event.
      name: status
      predefined:
      - new
      - investigating
      - closed
      required: true
    description: Modifies the status of multiple events.
    name: traps-event-bulk-update-status
  - arguments:
    - description: The SHA256 hash to add to the blacklist.
      name: hash_id
      required: true
    description: Adds the specified file hash to the blacklist.
    name: traps-hash-blacklist
    outputs:
    - contextPath: Traps.File.BlacklistStatus
      description: The status of the file hash ("blacklisted" or "none").
      type: String
    - contextPath: Traps.File.SHA256
      description: The SHA256 hash of the file.
      type: String
  - arguments:
    - description: The SHA256 hash to remove from the blacklist.
      name: hash_id
      required: true
    description: Removes the specified file hash from the blacklist.
    name: traps-hash-blacklist-remove
    outputs:
    - contextPath: Traps.File.BlacklistStatus
      description: The status of the file hash ("blacklisted" or "none").
      type: String
    - contextPath: Traps.File.SHA256
      description: The SHA256 hash of the file.
      type: String
  - arguments:
    - description: A comma-separated list of SHA256 file hashes for which to return
        the blacklist status.
      isArray: true
      name: hash_ids
      required: true
    description: Returns the blacklist status of the specified file hashes.
    name: traps-hashes-blacklist-status
    outputs:
    - contextPath: Traps.File.BlacklistStatus
      description: The blacklist status of the file hash. Can be "blacklisted" or
        "none".
      type: String
    - contextPath: Traps.File.SHA256
      description: The SHA256 hash of the file.
      type: String
  - arguments:
    - description: The ID of the event for which to create a quarantine entry..
      name: event_id
      required: true
    description: Creates a quarantine entry for the specified event.
    name: traps-event-quarantine
    outputs:
    - contextPath: Traps.Quarantine.EventID
      description: The ID of the event.
      type: String
    - contextPath: Traps.Quarantine.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.Quarantine.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the endpoint to isolate.
      name: endpoint_id
      required: true
    description: Isolates the specified endpoint.
    name: traps-endpoint-isolate
    outputs:
    - contextPath: Traps.Isolate.EndpointID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.Isolate.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.Isolate.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the operation for which to get the result of the quarantine
        operation.
      name: operation_id
      required: true
    description: Returns the result of the specified quarantine operation.
    name: traps-event-quarantine-result
    outputs:
    - contextPath: Traps.QuarantineResult.SHA256
      description: The SHA256 hash of the file.
      type: String
    - contextPath: Traps.QuarantineResult.FilePath
      description: The file path on the endpoint.
      type: String
    - contextPath: Traps.QuarantineResult.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.QuarantineResult.Status
      description: The status of the quarantine operation.
      type: String
  - arguments:
    - description: The ID of the operation.
      name: operation_id
      required: true
    description: Returns the status of the specified endpoint isolate operation.
    name: traps-endpoint-isolate-status
    outputs:
    - contextPath: Traps.IsolateResult.OperationID
      description: Operation ID. Use this to retrieve status / results.
      type: String
    - contextPath: Traps.IsolateResult.Status
      description: The status of the isolation operation.
      type: String
  - arguments:
    - description: The ID of the operation.
      name: operation_id
      required: true
    description: Returns the result of the endpoint file retrieve operation.
    name: traps-endpoint-files-retrieve-result
  - arguments:
    - description: The ID of the operation.
      name: operation_id
      required: true
    description: Returns the results of an endpoint scan operation.
    name: traps-endpoint-scan-result
    outputs:
    - contextPath: Traps.ScanResult.FileScanned
      description: The number of scanned files.
      type: Number
    - contextPath: Traps.ScanResult.FilesFailed
      description: The number of files that were not scanned.
      type: Number
    - contextPath: Traps.ScanResult.MalwareFound
      description: The number of detected malware.
      type: Number
    - contextPath: Traps.ScanResult.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.ScanResult.Status
      description: The status of the scan.
      type: String
  dockerimage: demisto/pyjwt3:1.0.0.7727
  runonce: false
  script: |
    import copy

    import urllib3
    import jwt



    # Disable insecure warnings
    urllib3.disable_warnings()

    PARAMS = demisto.params()
    # Remove trailing slash to prevent wrong URL path to service
    SERVER = PARAMS['url'][:-1] \
        if (PARAMS['url'] and PARAMS['url'].endswith('/')) else PARAMS['url']
    # Should we use SSL
    USE_SSL = not PARAMS.get('insecure', False)
    # Service base URL
    BASE_URL = SERVER + '/xapi/v1/'
    APPLICATION_ID = PARAMS.get('application_id')
    PRIVATE_KEY = PARAMS.get('private_key')
    # Headers to be sent in requests
    REQUEST_HEADERS = {
        'Content-Type': 'application/json'
    }

    OUTPUTS = {
        'get_endpoint_by_id': {
            'ID': 'guid',
            'Name': 'name',
            'Domain': 'domain',
            'Platform': 'platform',
            'ScanStatus': 'scanStatus',
            'Status': 'status',
            'IP': 'ip',
            'ComputerSid': 'computerSid',
            'IsCompromised': 'compromised',
            'OsVersion': 'osVersion',
            'OsProductType': 'osProductType',
            'OsProductName': 'osProductName',
            'Is64': 'is64',
            'LastSeen': 'lastSeen',
            'LastUser': 'lastUser'
        },
        'endpoint_files_retrieve': {
            'OperationID': 'operationId'
        },
        'endpoint_isolate': {
            'OperationID': 'operationId'
        },
        'endpoint_scan': {
            'OperationID': 'operationId'
        },
        'event_bulk_update_status': {
            'EventID': 'eventGuid'
        },
        'hashes_blacklist_status': {
            'SHA256': 'hash',
            'BlacklistStatus': 'status'
        },
        'event_quarantine_result': {
            'SHA256': 'fileHash',
            'FilePath': 'filePath'
        },
        'endpoint_scan_result': {
            'FileScanned': 'filesScanned',
            'FilesFailed': 'filesFailed',
            'MalwareFound': 'malwareFound'
        }
    }


    def create_headers(with_auth):
        """Create headers for the http_request

        Args:
            with_auth: True

        Returns:
            Headers.
        """
        headers = copy.deepcopy(REQUEST_HEADERS)
        if with_auth:
            token = generate_auth_token().decode('utf-8')
            headers['Authorization'] = f'Bearer {token}'
        return headers


    def extract_and_validate_http_response(response, operation_err_message, test=False):
        """

        Args:
            response: raw response
            operation_err_message: error message to present in case of error
            test: boolean value, true if test

        Returns:
            Error if response is faulty.
        """
        try:
            response.raise_for_status()
            return response.json() if not test else response.content
        except requests.exceptions.HTTPError:
            try:
                err_message = response.json().get('message')
            except Exception:
                try:
                    err_obj = json.loads(xml2json(response.text))
                    err_message = demisto.get(err_obj, 'Error.Message')
                except Exception:
                    err_message = f'Could not parse error'
            return_error(f'{operation_err_message}: \n{err_message}')


    def http_request(method, url_suffix, plain_url=False, params=None, data=None, operation_err=None, parse_response=True,
                     with_auth=True):
        """Generic http call to Traps

        Args:
            method: request method.
            url_suffix: URL suffix.
            plain_url: full URL.
            params: request params.
            data: request data.
            operation_err: operation error to log the user.
            parse_response: boolean value, if parsing the response is needed.
            with_auth: boolean value, do we need to authenticate the request.

        Returns:
            Result from the API.
        """
        try:
            result = requests.request(
                method,
                BASE_URL + url_suffix if not plain_url else url_suffix,
                verify=USE_SSL,
                params=params,
                data=json.dumps(data) if data else data,
                headers=create_headers(with_auth),
            )
        except requests.exceptions.ConnectionError:
            return_error(f'Error connecting to Traps server. Please check your connection and you server address')
        if parse_response:
            result = extract_and_validate_http_response(result, operation_err, plain_url)
        return result


    def health_check():
        """Performs basic health check on the server.

        Returns:
            Error if not ok.
        """
        path = f'{SERVER}/xapi/health-check'
        server_status = http_request('GET', path, plain_url=True).decode('utf-8')
        if server_status == '"Ok"':
            return
        raise Exception(f'Server health-check failed. Status returned was: {server_status}')


    def generate_auth_token():
        """Generate a token using jwt.

        Returns:
            token.
        """
        key = PRIVATE_KEY
        data = {'appId': APPLICATION_ID}
        token = jwt.encode(data, key, algorithm='RS256')
        return token


    def parse_data_from_response(resp_obj, operation_name=None):
        """Response raw data.

        Args:
            resp_obj: raw_data.
            operation_name: operation name.

        Returns:
            parsed data.
        """
        new_data_obj = {}  # type: dict
        outputs_obj = OUTPUTS[operation_name]
        for key, val in outputs_obj.items():
            if val in resp_obj:
                new_data_obj[key] = resp_obj.get(val)

        return new_data_obj


    def get_endpoint_by_id(endpoint_id):
        """Get endpoint data by sending a GET request.

        Args:
            endpoint_id: endpoint ID.

        Returns:
            endpoint data.
        """
        path = f'agents/{endpoint_id}'
        endpoint_data = http_request('GET', path, operation_err=f'Get endpoint {endpoint_id} failed')
        return parse_data_from_response(endpoint_data, 'get_endpoint_by_id'), endpoint_data


    def endpoint_files_retrieve(endpoint_id, file_name, event_id):
        """Retrieve a file from the endpoint by sending a POST request.

        Args:
            endpoint_id: endpoint ID.
            file_name: File name.
            event_id: Event ID.

        Returns:
            Operation data.
        """
        path = f'agents/{endpoint_id}/files-retrieve'
        data = {
            'incidentId': event_id,
            'files': [
                {
                    "path": file_name
                }
            ]
        }
        resp = http_request('POST', path, data=data,
                            operation_err=f'Files retrieve command on endpoint {endpoint_id} failed')
        operation_obj = parse_data_from_response(resp, 'endpoint_files_retrieve')
        operation_obj.update({
            'EndpointID': endpoint_id,
            'Type': 'files-retrieve'
        })
        return operation_obj


    def endpoint_scan(endpoint_id):
        """Initiate a scan on an endpoint by sending a POST request.

        Args:
            endpoint_id: endpoint ID.

        Returns:
            Operation data.
        """
        path = f'agents/{endpoint_id}/scan'
        response = http_request('POST', path, operation_err=f'Scanning endpoint: {endpoint_id} failed')
        operation_obj = parse_data_from_response(response, 'endpoint_scan')
        operation_obj.update({
            'EndpointID': endpoint_id,
            'Type': 'endpoint-scan'
        })
        return operation_obj, response


    def endpoint_scan_result(operation_id):
        """Initiate the SAM operation for retrieving the scan result.

        Args:
            operation_id: operation ID.

        Returns:
            scan data.
        """
        status, additional_data = sam_operation(operation_id, 'Could not get scan results')
        scan_data = parse_data_from_response(additional_data.get('scanData'),
                                             'endpoint_scan_result') if additional_data else {}
        scan_data['Status'] = status
        scan_data['OperationID'] = operation_id
        return scan_data


    def update_event_status(event_ids, status):
        """Update event or events status by sending a POST request.

        Args:
            event_ids: event IDs.
            status: status.

        Returns:
            API response.
        """
        path = f'events/status'
        data = {
            "guids": event_ids,
            "status": status
        }
        response = http_request('PATCH', path, data=data, operation_err=f'Update events {event_ids} status failed')
        return response


    def update_event_comment(event_id, comment):
        """Update event comment by sending a POST request.

        Args:
            event_id: event ID.
            comment: comment.
        """
        path = f'events/{event_id}/comment'
        data = {
            "comment": comment
        }
        http_request('POST', path, data=data, operation_err=f'Update event: {event_id} comment failed')


    def event_update(event_id, status, comment):
        """Initiate update of an event.

        Args:
            event_id: event ID.
            status: status.
            comment: comment.

        Returns:
            Error if not successful.
        """
        if not status and not comment:
            raise Exception('Please add a status or a comment. Neither was given.')
        if status:
            response = update_event_status([event_id], status)
            if response.get('failed'):
                raise Exception(f'Update status for event: {event_id} has failed.')
        if comment:
            update_event_comment(event_id, comment)


    def event_bulk_update_status(event_ids, status):
        """Initiate update of events statuses.

        Args:
            event_ids: event IDs.
            status: status.

        Returns:
            Update statuses.
        """
        ids_obj = update_event_status(event_ids, status)
        results = {
            'UpdateSuccess': list(
                map(lambda id_obj: parse_data_from_response(id_obj, 'event_bulk_update_status'), ids_obj.get('succeeded'))),
            'UpdateFail': list(
                map(lambda id_obj: parse_data_from_response(id_obj, 'event_bulk_update_status'), ids_obj.get('failed'))),
            'UpdateIgnored': list(
                map(lambda id_obj: parse_data_from_response(id_obj, 'event_bulk_update_status'), ids_obj.get('ignored')))
        }
        return results


    def hash_blacklist(hash_id):
        """Add hash to a blacklist by sending a POST request.

        Args:
            hash_id: Hash.

        Returns:
            status.
        """
        path = f'hashes/{hash_id}/blacklist'
        result = http_request('POST', path, operation_err=f'Failed to blacklist {hash_id}')
        return result.get('status')


    def remove_hash_from_blacklist(hash_id):
        """Remove hash to a blacklist by sending a POST request.

        Args:
            hash_id: Hash.

        Returns:
            status.
        """
        path = f'hashes/{hash_id}/blacklist-remove'
        result = http_request('POST', path, operation_err=f'Failed to remove {hash_id} from blacklist')
        return result.get('status')


    def hashes_blacklist_status(hash_ids):
        """Get hashes blacklisting status by sending a POST request.

        Args:
            hash_ids: Hashes.

        Returns:
            Hashes and blacklisting data.
        """
        path = f'hashes/blacklist-status'
        data = {
            'hashes': hash_ids
        }
        ids_obj = http_request('POST', path, data=data, operation_err='Failed to get hashes status')
        result = list(map(lambda id_obj: parse_data_from_response(id_obj, 'hashes_blacklist_status'), ids_obj))
        return result


    def event_quarantine(event_id):
        """Quarantine an event by sending a POST request.

        Args:
            event_id: event ID.

        Returns:
            Data regarding the event and the quarantine operation.
        """
        path = f'events/{event_id}/quarantine'
        resp = http_request('POST', path, operation_err=f'Quarantine event {event_id} failed')
        message_ids = resp.get('operationId').get('samMessageIds')
        operations = []
        for op_id in message_ids:
            operations.append({
                'EventID': event_id,
                'Type': 'event-quarantine',
                'OperationID': op_id
            })
        return operations


    def endpoint_isolate(endpoint_id):
        """Isolate an endpoint by sending a POST request.

        Args:
            endpoint_id: endpoint ID.

        Returns:
            Data regarding the endpoint and the isolation operation.
        """
        path = f'agents/{endpoint_id}/isolate'
        resp = http_request('POST', path, operation_err=f'Isolation of endpoint: {endpoint_id} failed')
        operation_obj = parse_data_from_response(resp, 'endpoint_isolate')
        operation_obj.update({
            'EndpointID': endpoint_id,
            'Type': 'endpoint-isolate'
        })
        return operation_obj


    def sam_operation(operation_id, operation_err):
        """
        This functions invokes an API call to the sam operation endpoint on Traps server to get the operation status and/or
        results.
        :param operation_id: the operation on which to get the status/results
        :param operation_err: The error to return in case of a failure (changes according to the command fired.)
        :return:
            status: the status of the operation.
            additional_data: additional data regarding the operation (like scan results)
        """
        path = f'sam/operations/{operation_id}'
        result = http_request('GET', path, operation_err=operation_err)
        summary_data = result.get('summaryData')
        if summary_data and (summary_data.get('incompatible') or summary_data.get('samExists')):
            if operation_err == 'Could not get scan results':  # Get scan result
                requested_scans = int(summary_data.get('requested', 0))
                incompatible_scans = int(summary_data.get('incompatible', 0))
                sam_exists_scans = int(summary_data.get('samExists', 0))
                if requested_scans <= incompatible_scans + sam_exists_scans:
                    raise Exception(f'{operation_err}.\nRequested scans number: {requested_scans}.\n'
                                    f'Incompatible scans number: {requested_scans}.\n'
                                    f'Sam exists scans number: {sam_exists_scans}.')
            raise Exception(f'{operation_err}')
        if result.get('summaryData').get('samExists'):
            return 'ignored', None
        for status_obj in result.get('statuses'):
            if status_obj.get('count') > 0:
                return status_obj.get('status'), result.get('additionalData')
        raise Exception(f'{operation_err}: Could not retrieve status')


    def endpoint_isolate_status(operation_id):
        """Initiate the SAM operation for endpoint isolation status.

        Args:
            operation_id: operation ID.

        Returns:
            endpoint status, operation ID
        """
        status, _ = sam_operation(operation_id, f'Could not get endpoint isolate status')
        return {'Status': status, 'OperationID': operation_id}


    def event_quarantine_result(operation_id):
        """Initiate the SAM operation for quarantine result.

        Args:
            operation_id: operation ID.

        Returns:
            quarantine data.
        """
        status, additional_data = sam_operation(operation_id, f'Could not get event quarantine status')
        quarantine_data = parse_data_from_response(additional_data.get('quarantineData'),
                                                   'event_quarantine_result') if additional_data else {}
        quarantine_data['Status'] = status
        quarantine_data['OperationID'] = operation_id
        return quarantine_data


    def endpoint_files_retrieve_result(operation_id):
        """Initiate the SAM operation for file retrieving.

        Args:
            operation_id: operation ID.

        Returns:
            file as an entry, status, operation_id.
        """
        status, additional_data = sam_operation(operation_id, f'Failed to get file retrieve results')
        if status == 'finished':
            file_info = additional_data.get('uploadData')
            file_name = file_info.get('fileName')
            url = file_info.get('downloadUrl')
            data = http_request('GET', url, plain_url=True, operation_err=f'Unable to download file.', with_auth=False)
            demisto.results(fileResult(filename=file_name, data=data))
        return {'Status': status, 'OperationID': operation_id}


    def test_module_command():
        """Performs basic GET request to check if the API is reachable and authentication is successful.

        Returns:
            ok if successful.
        """
        health_check()
        result = http_request('GET', 'agents/1', parse_response=False)
        if result.status_code == 403:
            raise Exception('Error connecting to server. Check your Application ID and Private key')
        demisto.results('ok')


    def get_endpoint_by_id_command():
        """Get endpoint data.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        endpoint_data, raw_data = get_endpoint_by_id(endpoint_id)
        human_readable = tableToMarkdown(f'Endpoint {endpoint_id} data:', endpoint_data, headerTransform=pascalToSpace)
        context = {'Traps.Endpoint(val.ID == obj.ID)': createContext(endpoint_data)}
        return_outputs(human_readable, context, raw_response=raw_data)


    def endpoint_files_retrieve_command():
        """Initiate retrieving of files from an endpoint.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        file_name = args.get('file_name')
        event_id = args.get('event_id')
        operation_obj = endpoint_files_retrieve(endpoint_id, file_name, event_id)
        human_readable = tableToMarkdown(f'Files retrieve command on endpoint: {endpoint_id} received', operation_obj,
                                         headerTransform=pascalToSpace)
        context = {'Traps.FileRetrieve(val.OperationID == obj.OperationID)': operation_obj}
        return_outputs(human_readable, context, operation_obj)


    def endpoint_files_retrieve_result_command():
        """Retrieve files from an endpoint result.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        operation_id = args.get('operation_id')
        status_obj = endpoint_files_retrieve_result(operation_id)
        human_readable = f'### File retrieval status is: {status_obj.get("Status")}'
        context = {'Traps.FileRetrieveResult(val.OperationID == obj.OperationID)': status_obj}
        return_outputs(human_readable, context)


    def endpoint_scan_command():
        """Initiate scan on an endpoint.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')

        # check that running a scan is possible
        _, raw_data = get_endpoint_by_id(endpoint_id)
        scan_status = raw_data.get('scanStatus')
        if scan_status and scan_status in ['pending', 'in_progress']:
            raise Exception(f'Could not initiate a scan on the endpoint {endpoint_id}'
                            f' because endpoint scan status is {scan_status}.')

        operation_obj, raw_data = endpoint_scan(endpoint_id)
        human_readable = tableToMarkdown(f'Scan command on endpoint: {endpoint_id} received', operation_obj,
                                         headerTransform=pascalToSpace)
        context = {'Traps.Scan(val.OperationID == obj.OperationID)': operation_obj}
        return_outputs(human_readable, context, raw_data)


    def endpoint_scan_result_command():
        """Retrieve endpoint scan results.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        operation_id = args.get('operation_id')
        status_obj = endpoint_scan_result(operation_id)
        context = {f'Traps.ScanResult(val.OperationID == obj.OperationID)': status_obj}
        human_readable = tableToMarkdown(f'Status of scan operation: {operation_id}', status_obj,
                                         headerTransform=pascalToSpace)
        return_outputs(human_readable, context, status_obj)


    def event_update_command():
        """Update an event.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        event_id = args.get('event_id')
        status = args.get('status')
        comment = args.get('comment')
        event_update(event_id, status, comment)
        human_readable = f'### Event: {event_id} was updated'
        human_readable += f'\n##### New status: {status}' if status else ''
        human_readable += f'\n##### New comment: {comment}' if comment else ''
        return_outputs(human_readable, None, {})


    def event_bulk_update_status_command():
        """Update events.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        event_ids = argToList(args.get('event_ids'))
        status = args.get('status')
        results = event_bulk_update_status(event_ids, status)
        human_readable = tableToMarkdown('Successfully updated', results.get('UpdateSuccess'),
                                         headerTransform=pascalToSpace)
        human_readable += tableToMarkdown('Failed to update', results.get('UpdateFail'), headerTransform=pascalToSpace)
        human_readable += tableToMarkdown('Ignored', results.get('UpdateIgnored'), headerTransform=pascalToSpace)
        return_outputs(human_readable, {}, {})


    def event_quarantine_command():
        """Quarantine an event.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        event_id = args.get('event_id')
        operations = event_quarantine(event_id)
        human_readable = tableToMarkdown(f'Quarantine command on event: {event_id} received', operations,
                                         headerTransform=pascalToSpace)
        context = {'Traps.Quarantine(val.OperationID == obj.OperationID)': operations}
        return_outputs(human_readable, context, operations)


    def event_quarantine_result_command():
        """Check quarantine event status.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        operation_id = args.get('operation_id')
        status_obj = event_quarantine_result(operation_id)
        context = {f'Traps.QuarantineResult(val.OperationID == obj.OperationID)': status_obj}
        human_readable = tableToMarkdown(f'Status of quarantine operation: {operation_id}',
                                         status_obj, headerTransform=pascalToSpace)
        return_outputs(human_readable, context, status_obj)


    def hash_blacklist_command():
        """Add a hash to a blacklist.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        hash_id = args.get('hash_id')
        status = hash_blacklist(hash_id)
        context = {}  # type: dict
        if status == 'success':
            human_readable = f'#### Successfully blacklisted: {hash_id}'
            status_obj = {
                'SHA256': hash_id,
                'BlacklistStatus': 'blacklisted'
            }
            context = {'Traps.File(val.SHA256 == obj.SHA256)': status_obj}

        elif status == 'ignore':
            human_readable = f'#### Hash: {hash_id} already appears in blacklist'
        else:
            human_readable = f'#### Failed to blacklist: {hash_id}'
        return_outputs(human_readable, context, status)


    def hash_blacklist_remove_command():
        """Remove a hash from blacklist.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        hash_id = args.get('hash_id')
        status = remove_hash_from_blacklist(hash_id)
        context = {}  # type: dict
        if status == 'success':
            human_readable = f'#### Successfully removed {hash_id} from blacklist'
            status_obj = {
                'SHA256': hash_id,
                'BlacklistStatus': 'none'
            }
            context = {'Traps.File(val.SHA256 == obj.SHA256)': status_obj}
        else:
            human_readable = f'#### Failed to remove {hash_id} from blacklist:'

        return_outputs(human_readable, context, status)


    def hashes_blacklist_status_command():
        """Check hash blacklist status.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        hash_ids = args.get('hash_ids').split(',')
        ids_obj = hashes_blacklist_status(hash_ids)
        human_readable = tableToMarkdown('Hashes status:', ids_obj, headerTransform=pascalToSpace)
        context = {'Traps.File(val.SHA256 == obj.SHA256)': ids_obj}
        return_outputs(human_readable, context, ids_obj)


    def endpoint_isolate_command():
        """Isolate an endpoint.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        operation_obj = endpoint_isolate(endpoint_id)
        human_readable = tableToMarkdown(f'Isolate command on endpoint {endpoint_id} received', operation_obj,
                                         headerTransform=pascalToSpace)
        context = {'Traps.Isolate(val.OperationID == obj.OperationID)': operation_obj}
        return_outputs(human_readable, context, operation_obj)


    def endpoint_isolate_status_command():
        """Check endpoint isolation status.

        Returns:
            Demisto Outputs.
        """
        args = demisto.args()
        operation_id = args.get('operation_id')
        isolate_status = endpoint_isolate_status(operation_id)
        human_readable = f'### Isolate status is: {isolate_status.get("Status")}'
        context = {f'Traps.IsolateResult(val.OperationID == obj.OperationID)': isolate_status}
        return_outputs(human_readable, context, isolate_status)


    def main():
        """
        Initiate integration command
        """
        # Remove proxy if not set to true in params
        handle_proxy()
        command = demisto.command()
        LOG(f'Command being called is {command}.')
        try:
            if command == 'test-module':
                test_module_command()
            elif command == 'traps-get-endpoint-by-id':
                get_endpoint_by_id_command()
            elif command == 'traps-endpoint-files-retrieve':
                endpoint_files_retrieve_command()
            elif command == 'traps-endpoint-files-retrieve-result':
                endpoint_files_retrieve_result_command()
            elif command == 'traps-endpoint-scan':
                endpoint_scan_command()
            elif command == 'traps-endpoint-scan-result':
                endpoint_scan_result_command()
            elif command == 'traps-event-update':
                event_update_command()
            elif command == 'traps-event-bulk-update-status':
                event_bulk_update_status_command()
            elif command == 'traps-hash-blacklist':
                hash_blacklist_command()
            elif command == 'traps-hash-blacklist-remove':
                hash_blacklist_remove_command()
            elif command == 'traps-hashes-blacklist-status':
                hashes_blacklist_status_command()
            elif command == 'traps-event-quarantine':
                event_quarantine_command()
            elif command == 'traps-event-quarantine-result':
                event_quarantine_result_command()
            elif command == 'traps-endpoint-isolate':
                endpoint_isolate_command()
            elif command == 'traps-endpoint-isolate-status':
                endpoint_isolate_status_command()
            else:
                raise NotImplementedError(f'Command {command} was not implemented.')
        except Exception as err:
            return_error(err)


    if __name__ in ["__builtin__", "builtins", "__main__"]:
        main()
  subtype: python3
  type: python
system: true
