beta: true
category: Endpoint
commonfields:
  id: Palo Alto Traps ESM (Beta)
  version: -1
configuration:
- defaultvalue: ""
  display: URL of Traps ESM Server
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Username of Account to be used.
  name: username
  required: false
  type: 0
- defaultvalue: ""
  display: Password of Account to be used.
  name: password
  required: false
  type: 4
contentitemexportablefields:
  contentitemfields:
    propagationLabels:
    - all
description: Palo Alto Traps ESM beta integration.
detaileddescription: 'Note: This is a beta Integration, which lets you implement and
  test pre-release software. Since the integration is beta, it might contain bugs.
  Updates to the integration during the beta phase might include non-backward compatible
  features. We appreciate your feedback on the quality and usability of the integration
  to help us identify issues, fix them, and continually improve.'
display: Palo Alto Traps ESM (Beta)
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAABGdBTUEAALGPC/xhBQAADNlJREFUeAHtWgtwVNUZPufefeUdoqBUYnY3m5CQClR8YalSh9aiYqCVzuALaJVqO/XB1KqjYzO2+ADro2MZtXUyPLRaRE1ttU61ZIoWBwkgIRaS3ewGH6Ahj40J2WT33tPvv8m53F13SQJi1d47k5zXf/7/nO87/zn/OQlj9mcjYCNgI2AjYCNgI2AjYCNgI2AjYCNgI2AjYCNgI2AjYCNgI2AjYCNgI2AjYCNgI2AjYCPwf4oAH828o5eW3ci5aM2vC76UTr5rfqBG5cpr+S80v5Gu/YtQF/D66oUQ5w+Nhb8Ragt/6/MaV8Dr3SEEmz5s+2+wfcnnZVsZyVBXdeBmnekP64w911MdmJcq310duJfp4learr/Ss6B8Vmq7Xc6MwNTS0gnlfv+sQIn/R+Xl5adkljz6liMSTOQyIR4k9Vj9rlSSiVzU32aYFyLXJnn0RJSXlM7tS2gfaZq+WTD9SX1AP3X0vUcv6cgkaiVXyhgkc06efBnIPtck97CAJHnuF3m7lsP9KqYBb+AcRdFzNJ07PTmerWkJTkeuBGPIk5VKwUWVrLOmXAgoF2WoG9V5XFbi/z50/dLQwVnDlYsX/3xd7ZrbGWdXIUCYiLOrEW2vFJ5YtLKhoSEubS1cuFDdsW3bRWj/AeqmYIsJQL6fcR7EfvPyJOZ9pD5SH5PyI6VlPt95QmfXwO5UwZiXCdaCuGMXE45Hg23BHdb+M2bMcPZ0dV0qNDEfspWMi1IueC9S2FbqCk4Y93vrWK19M+cTf0Sc8IlsF0ypCUVCf6cyMOcBv/8aYHsRxjWVMZ4PW42Qedvpca3cs2dPB8lVVVW54v39OboQczH2dxL9Cf+ngqwjkUtKOOe3F9YF7xMLq1zdgwPPwbp5LkMZbPJrC18MPkmyo/kCXv/1Quirh2X3Q/9mTOiHqX05Z1sUl+vS5ubmg3Re6QPxesFEIFVOljGWVkeW5yw5+UxBFpHV3dH5KOZxLfp+Cg/OeAKT/m0w0mocRZV+f9mgLl6DfMYtFUqaVI975t69ew3C0gVZtEVrTHtZjjc15Qq/KhgOr6/wVngTLPY0FvLMVBkqY3wHFaYsa24LvRAIBNwiLs5VmH6RzsU2h+IOJZ3BoyXXMPTn3XHOxIfSaCq5oma2I1pdWjvGwAseO0QuiB6UuimlCYLU+ygP4GBXqJQ3P86jmO0BWYZn+RP9A4/IcqY02tF1B5QvQ7tJrtU2FpEDC/DWMq//OtKRPW5cBImH8vJDx04sgo9lGbartMFBY6yybqQUNntIj/yB/EBNTY2SjlzImjsZxneixrWny73lFcFgcMDhYINc5fB8NYqRR0yCx0IubRnR+YHVAP0nNHAMKslzDXK3v/+0LtiSMQdenO9TFX52S7jVwxzqGdAdluBgMkuxSqdggoJx5Q9DhPI7XQr3hiLhwlAkMpFz5W4pj3bs5AuTF4LZyFiF318Ocu8wqzhvge3pZNvhUGfBtrmAMedVsD2etl54TS3G8B52q1u401EcbIucAPsnYUzmghK6WGTqHU1GqN8jPeZPOLxhfe3a66yeC7sbVbdrPHDJUzijBYdQCJ9gHp3FH6Ps3lDozebW1tdpe6fdziD4KMk1VnQmckHGQjIIAGXgNaorlKLw5c3h8FYiMRQKNQDEmww9Q78UpmnnUjY7P/d3npycEtwpV8RV9RCuG3PougGD50t5kOJqbGgoleXUNC7EbPJQWQ9yfwrb75BtAgq2jW2Z2iGXC9vnUF51O1dM8pb4Q+HwA+6EOxHw+b5b6vNdy5l+NrUPf+O+7vOdJAtHkwquz7H061I9rqVEGnlqSyTyOI6tZ2Q75jprtne2R5ZlqhxXcqWVMZCsulz1shulKG+ylrFgjOBO07R47NChGwIl3pCIJz7GdeMfdN3ARE2CqR8CjowgI2gZfnwwLOjOrKx/JdlS1VTb36D2oqKixAdtbbeVen1tMdG3H976Kgw9AW8zFoDUgX00o20pM0Jq2BuS4Q3yTJd9BOf1Mo9U/VDZd5qlbGQVuHBxaqUsYyUbARWVAZzclkfnuVKJmQoVW7bbLGbI5OTk9FubHA7HAMpC1mFvzqazKdbb9wpAXYUGv2wbDogo6h7lx3OkIOaawHaekGVKYTtpLIiQsykoa99/oF7Xxa8BihlooT+2btZk7X+seczHMj7cEFI+2Euq03XFlJeiSkFdcLnC+UOyQqafKbmc9XOuzit8sfl1qT9TGu2I4hpw+IvFYrQqMZehD5P+z1Nr1y5A6QJZh7NvpUNVzhz/tZPzscXfbtaPkIHH7ZIitJ0/VfvUZFmmVMTj06xlprDG6MGuqyB7lqzHNlmDc3gGnYucKffI+rGmqkPA15K/pPExcRo5mVWC6yxpfO4ctzkfKWcoTSX5f0UuDUqIxAp4STbl6Uzhmp4CmrITQpatix0qPGHcnXtbW7dt2bKlX9eSt2jSk+lTFbbV2iZ44n66S1Id0txEQr/b2o7D+m2M0LQNnNpbwuG7cSZup3NR5+w8q/yR8tzBeqztCEbN46LS5yuhNoQCh8cnmLfMV3qj7FNWUlYJe3S1Mz4wH2pqauqUZZmaAQaRHK0O0F74Md1zSeCYt+UxeK4cENILogc7mgMlvh3vi7bpCG4myTZM4t/BSLAed+dKjE5WZ3d3dNThoWITxluJn6tlw0gpAqrNuB/XoU81ySKdF+s71FJa4mvEEXA6qiaaOrjy+J7W1mbY/gCCRjXkx8Pu8wiw3oQ3Tcd16nJTfoSMxnlzkohg92Is38EoSnDPngYCq1w5rgdifX1LMdWTSRb6H8LYrsSu0amL+DdRbziC0cbVXyTpGy4kbQtEciZyDXlcfAEynYlMXoXMaHlYoZkcHbnUfT/gOwV6L7GSi+Uc5dz5MxJws6wXsFUfpLzxCTYXZ+JK4L4UcnhNGv3n4bjqWcE2zlVxMTQcJpfxBk9OlgEgIuhn4bmHX5wEmz8UC4grkvSMMAR4fDvm8JwUw2LJo4WGOZAn42Esvow8EngvsdoD8jMgh4VwmFy6nuFa9KLUZU2TCJYNUJAUUB2uZwra1kQXlF4dxT33OJDLnKpyIez9U9pEqmO+b6gu5+ktkZadVN8UaTqA6BAk8N1SDiAM4qR+xpOTfQbySduflEmX7g6HP+IOdSrO7hXo126VAbgf0l339LPOOBtg91IbItkwQJ4HMltMWc5i8Kpah9t1JkhLCtRMmTQZxe28nsac2gRdm6B/E9UHI5FXcb5PgdzzGE+fRVaHzC68eF0YirTeZKlPyqJP+g/b9YO4Ytyc2mpMQLAr4Mp4ohRXprZjIKMOqKhvylMlc3jcp9BLlfFEJxITmZM1YbWnJYwW4hS//1Sd8/GaojTSOUg6J0+enJc1kGU8cJSdWfbJhg0bNDpTnX1O40iK58QTkjCSt350d40J1efwOFrkM6e1XebJNuz4dF0vLCgowHV76J0cjyH5uYlcw3HmL5nfg4hft9rW8/X4rl27rESxGX5/QTfnAVXXE568vGBqu7RJt4d169b5US6YMGHCuxRzyLZMaUaCqUMqycOr8/LCvwQ3CBjr3r5+TRLJYySXbGQimNrs79gRMIOsdKpk4EWebCWXZDlWJkheDJJRgicfBbnpbH6Z6+hZFF6f39jY2AWvLdq9e3fXNDxv0pychYW9rKvLGefceAsoKi7ubG9vz0ef7o0bNxZUVFT0tLzdkrczsrN75syZWZ2dnQ562KCbRKf6Xj71xy5xiNoGBwd5Xkeevt+930ky9I8DRVpxT7q/nh3RgyXY3dVlqxDCbSXPlXUyJU+O7lj/GA76Z0dzz5X9ZPpV8mB6J2cJbQdi0fNwQD6Bs30Oynj8EC8Jpm7gTJuGAJLOy+1CUa7nutiM59Ef65r+DBzkCjzoL8Bz55+w+/8GVyQ8nKhr0QcPZewGtA8iRrhL6LyMK6IIwdgcnM3LWSKBgIt/G3oP4D18icRVpmmDLNko08K6llvSkUvt5MmIvJcdDbnUfxI7tZYe0OXPokWLDlD9l/YTYhvAX22OH09vuHu46I/vCJjuh0ftdHC+vLW1dR8a3tU0cStE3gKpt4BUPAQpF+DhaTXIxH/LDL9F45UI+hDwsxjpxd+tF+O3QMyxHXLbcV3qha6TKC4w7Q5njrhFpwofj/LwtmIMnPQjkDgeZj4XnW63u3dA1/+qcv4WHi4uy83NjfdGo1vwty9tsL9/NgbxPAjZ5lZVI8hSmLpGV/SLXar64GBCu8ednf06j/G3YnrfXbgnqW63Y1U8kRiPPg+jbzHH0ymPx/fBrW5lQimlP3LAQ4sRZMZBMv5BAZbsz0bARsBGwEbARsBGwEbARsBGwEbARsBGwEbARsBGwEbARsBGwEbARsBGwEbARuCzROC/A75cYaeLqTEAAAAASUVORK5CYII=
name: Palo Alto Traps ESM (Beta)
script:
  commands:
  - arguments:
    - name: hash
      required: true
    description: Retrieve details about a specific hash
    name: traps-esm-hash-detail
  - arguments:
    - description: Hash to be changed.
      name: hash
      required: true
    - auto: PREDEFINED
      description: Verdict of the hash.
      name: verdict
      predefined:
      - Benign
      - Malware
      required: true
    description: Override a verdict for a specific hash.
    name: traps-esm-override-hash-verdict
  dockerimage: demisto/btfl-soup:1.0.0.925
  runonce: false
  script: |2



    ''' IMPORTS '''

    import json
    import requests
    from bs4 import BeautifulSoup
    from base64 import b64decode, b64encode
    from Crypto.PublicKey import RSA  # nosec
    from Crypto.Cipher import PKCS1_v1_5  # nosec

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS/PARAMS '''

    USERNAME = demisto.params().get('username')
    PASSWORD = demisto.params().get('password')
    URL = demisto.params().get('url')

    USE_SSL = False


    def logout_traps():
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate"
        }
        result = requests.request('GET', URL + '/EndpointSecurityManager/Account/Logout',
                                  headers=headers, verify=USE_SSL)
        c = result.content
        demisto.results(c)


    def get_new_request_token(cookies):
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate"
        }
        result = requests.request('GET', URL + '/EndpointSecurityManager/HashManagement/Hashes',
                                  headers=headers, verify=USE_SSL, cookies=cookies)
        # Extracting Token
        c = result.content
        request_verification_token = None

        soup = BeautifulSoup(c, 'html.parser')
        request_verification_obj = soup.find('input', {"name": "__RequestVerificationToken"})
        request_verification_token = request_verification_obj['value']
        return request_verification_token


    def get_ct_cookie():
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate"
        }
        result = requests.request('GET', URL + '/EndpointSecurityManager/Account/Login',
                                  headers=headers, verify=USE_SSL)
        # Extracting Token
        c = result.content
        soup = BeautifulSoup(c, 'html.parser')
        request_verification_obj = soup.find('input', {"name": "__RequestVerificationToken"})
        request_verification_token = request_verification_obj['value']

        # Extracting Cookie
        cookie_dough = result.cookies
        ct_value = None
        for cookie in cookie_dough:
            baked_cookie = cookie.__dict__
            if baked_cookie['name'] == 'ct':
                ct_value = baked_cookie['value']
        return request_verification_token, ct_value


    def get_rsa_csid_key(request_verification_token, ct_value):
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "token": request_verification_token
        }
        cookies = {'ct': ct_value}
        result = requests.request('POST', URL + '/EndpointSecurityManager/Account/PublicKey',
                                  headers=headers, cookies=cookies, verify=USE_SSL)
        # Extracting Cookie
        cookie_dough = result.cookies
        csid = None
        for cookie in cookie_dough:
            baked_cookie = cookie.__dict__
            if baked_cookie['name'] == 'csid':
                csid = baked_cookie['value']
        # Extracting RSA
        key = result.json().get('key')
        salt = result.json().get('salt')
        return key, salt, csid


    def bytes_to_integer(data):
        output = 0
        size = len(data)
        for index in range(size):
            output |= data[index] << (8 * (size - 1 - index))
        return output


    def get_auth_cookie():
        request_verification_token, ct_value = get_ct_cookie()
        key, salt, csid = get_rsa_csid_key(request_verification_token, ct_value)
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "token": request_verification_token
        }
        cookies = {
            'ct': ct_value,
            'csid': csid
        }
        salted_password = (salt + PASSWORD).encode()

        keyDER = b64decode(key)
        keyPub = RSA.importKey(keyDER)

        # Encrypt the session key with the public RSA key
        cipher_rsa = PKCS1_v1_5.new(keyPub)
        encrypted_pass = cipher_rsa.encrypt(salted_password)
        b64pass = b64encode(encrypted_pass)

        payload = {
            "Username": USERNAME,
            "Password": b64pass
        }
        result = requests.request('POST', URL + '/EndpointSecurityManager/Account/Login',
                                  headers=headers, cookies=cookies, data=payload, verify=USE_SSL)
        # Extracting Cookie
        cookie_dough = result.cookies
        csid = None
        for cookie in cookie_dough:
            baked_cookie = cookie.__dict__
            if baked_cookie['name'] == 'auth':
                cookies['auth'] = baked_cookie['value']
        return request_verification_token, cookies


    def traps_esm_hash_detail():
        request_verification_token, cookies = get_auth_cookie()
        file_hash = demisto.args().get('hash')
        token = get_new_request_token(cookies)
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "Referer": URL + "/EndpointSecurityManager/HashManagement/Hashes",
            "X-Requested-With": "XMLHttpRequest",
            "Origin": URL,
            "Content-Type": "application/json; charset=UTF-8",
            "Token": token
        }
        payload_raw = {
            'hash': file_hash
        }

        payload = json.dumps(payload_raw)

        auth_cookie = {
            'ct': cookies['ct'],
            'csid': cookies['csid'],
            'auth': cookies['auth']
        }

        result = requests.request('POST', URL + '/EndpointSecurityManager/HashManagement/HashesDetail',
                                  headers=headers, cookies=auth_cookie, data=payload, verify=USE_SSL)

        hash_results = json.loads(result.content)

        hr_table = {
            'Result': hash_results['LocalAnalysis'][0]['Result'],
            'Verdict History': hash_results['VerdictHistory'],
            'Quarantined': hash_results['Quarantined']
        }

        ec = {
            'TrapsESM': hash_results
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['markdown'],
            'Contents': 'The verdict of hash {} is {}'.format(file_hash, hash_results['LocalAnalysis'][0]['Result']),
            'HumanReadable': tableToMarkdown('Hash Verdict for {}'.format(file_hash), hr_table),
            'EntryContext': ec
        })


    def traps_esm_override_hash_verdict():
        request_verification_token, cookies = get_auth_cookie()
        token = get_new_request_token(cookies)
        file_hash = demisto.args().get('hash')
        verdict = demisto.args().get('verdict')
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "X-Requested-With": "XMLHttpRequest",
            "Origin": URL,
            "Content-Type": "application/json; charset=UTF-8",
            "token": token
        }
        payload = {
            'request': [file_hash],
            'verdict': verdict
        }

        result = requests.request('POST', URL + '/EndpointSecurityManager/HashManagement/OverrideHashVerdict',
                                  headers=headers, cookies=cookies, data=payload, verify=USE_SSL)

        demisto.results(result.content)


    ''' COMMANDS MANAGER / SWITCH PANEL '''

    LOG('Command being called is %s' % (demisto.command()))

    try:
        if demisto.command() == 'test-module':
            auth_cookie = get_auth_cookie()
            if auth_cookie:
                demisto.results('ok')
        elif demisto.command() == 'traps-esm-hash-detail':
            traps_esm_hash_detail()
        elif demisto.command() == 'traps-esm-override-hash-verdict':
            traps_esm_override_hash_verdict()

    # Log exceptions
    except Exception as e:
        LOG(str(e))
        LOG.print_log()
        raise
  subtype: python3
  type: python
system: true
